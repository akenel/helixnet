{% extends "camper/base.html" %}

{% block title %}Bay Timeline - Camper & Tour{% endblock %}
{% block page_name %}Bay Timeline{% endblock %}

{% block extra_head %}
    <style>
        /* Bay Timeline - CSS Grid resource timeline */
        .timeline-grid {
            display: grid;
            gap: 0;
            overflow-x: auto;
            min-width: 100%;
        }
        .timeline-header {
            background: #f9fafb;
            border-bottom: 2px solid #e5e7eb;
            font-weight: 600;
            font-size: 0.75rem;
            color: #6b7280;
            text-align: center;
            padding: 8px 4px;
            position: sticky;
            top: 0;
            z-index: 5;
        }
        .timeline-header.today {
            background: #fffbeb;
            color: #92400e;
            border-bottom-color: #d97706;
        }
        .bay-label {
            background: white;
            border-right: 2px solid #e5e7eb;
            border-bottom: 1px solid #f3f4f6;
            padding: 8px 12px;
            font-weight: 600;
            font-size: 0.85rem;
            color: #1f2937;
            position: sticky;
            left: 0;
            z-index: 4;
            min-width: 140px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        .bay-label .bay-type {
            font-size: 0.65rem;
            font-weight: 400;
            color: #9ca3af;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        .bay-cell {
            border-bottom: 1px solid #f3f4f6;
            border-right: 1px solid #f3f4f6;
            min-height: 60px;
            position: relative;
            background: white;
        }
        .bay-cell.today {
            background: #fffbeb;
        }
        .bay-cell.weekend {
            background: #fafafa;
        }
        .job-bar {
            position: absolute;
            top: 4px;
            bottom: 4px;
            left: 2px;
            right: 2px;
            border-radius: 6px;
            padding: 4px 8px;
            font-size: 0.7rem;
            font-weight: 500;
            color: white;
            cursor: pointer;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
            transition: transform 0.15s, box-shadow 0.15s;
            z-index: 3;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        .job-bar:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            z-index: 10;
        }
        .job-bar.waiting {
            background-image: repeating-linear-gradient(
                45deg,
                transparent,
                transparent 5px,
                rgba(255,255,255,0.15) 5px,
                rgba(255,255,255,0.15) 10px
            );
        }
        .job-bar .job-plate {
            font-weight: 700;
            font-size: 0.75rem;
        }
        .job-bar .job-title {
            font-size: 0.65rem;
            opacity: 0.9;
        }
        .legend-item {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 0.75rem;
            color: #4b5563;
        }
        .legend-swatch {
            width: 14px;
            height: 14px;
            border-radius: 3px;
        }
        .legend-swatch.striped {
            background-image: repeating-linear-gradient(
                45deg,
                #f59e0b,
                #f59e0b 3px,
                rgba(255,255,255,0.3) 3px,
                rgba(255,255,255,0.3) 6px
            );
        }
    </style>
{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50" x-data="bayTimelineData()">
    <!-- Top Navigation -->
    <nav class="bg-white shadow-lg sticky top-0 z-20">
        <div class="max-w-full mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center space-x-4">
                    <span class="text-2xl">&#x1F69C;</span>
                    <div>
                        <h1 class="text-xl font-bold text-gray-900">Camper & Tour</h1>
                        <p class="text-xs text-gray-500">Gestione Servizi</p>
                    </div>
                </div>
                <div class="hidden md:flex items-center space-x-2">
                    <a href="/camper/dashboard" class="px-3 py-2 rounded-lg text-sm font-medium text-gray-600 hover:bg-gray-100">Cruscotto</a>
                    <a href="/camper/checkin" class="px-3 py-2 rounded-lg text-sm font-medium text-gray-600 hover:bg-gray-100">Accettazione</a>
                    <a href="/camper/jobs" class="px-3 py-2 rounded-lg text-sm font-medium text-gray-600 hover:bg-gray-100">Lavori</a>
                    <a href="/camper/customers" class="px-3 py-2 rounded-lg text-sm font-medium text-gray-600 hover:bg-gray-100">Clienti</a>
                    <a href="/camper/quotations" class="px-3 py-2 rounded-lg text-sm font-medium text-gray-600 hover:bg-gray-100">Preventivi</a>
                    <a href="/camper/purchase-orders" class="px-3 py-2 rounded-lg text-sm font-medium text-gray-600 hover:bg-gray-100">Ordini Acquisto</a>
                    <a href="/camper/invoices" class="px-3 py-2 rounded-lg text-sm font-medium text-gray-600 hover:bg-gray-100">Fatture</a>
                    <a href="/camper/calendar" class="px-3 py-2 rounded-lg text-sm font-medium text-gray-600 hover:bg-gray-100">Calendario</a>
                    <a href="/camper/bay-timeline" class="px-3 py-2 rounded-lg text-sm font-medium bg-amber-100 text-amber-800">Piazzole</a>
                </div>
                <div class="flex items-center space-x-3">
                    <span class="text-sm text-gray-600" x-text="user.username"></span>
                    <button @click="logout()" class="text-red-600 hover:text-red-700 text-sm">Esci</button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="max-w-full mx-auto px-4 sm:px-6 lg:px-8 py-6 pb-16">

        <!-- Controls -->
        <div class="card mb-6">
            <div class="flex flex-wrap items-center justify-between gap-4">
                <div class="flex items-center gap-3">
                    <h2 class="text-lg font-bold text-gray-900">Piazzole - Timeline</h2>
                    <span class="text-sm text-gray-500" x-text="dateRangeLabel"></span>
                </div>
                <div class="flex items-center gap-2">
                    <button @click="prevWeek()" class="btn-secondary !py-2 !px-3 text-sm">&larr; Settimana Prec.</button>
                    <button @click="thisWeek()" class="btn-primary !py-2 !px-3 text-sm">Oggi</button>
                    <button @click="nextWeek()" class="btn-secondary !py-2 !px-3 text-sm">Settimana Succ. &rarr;</button>
                </div>
            </div>
            <!-- Legend -->
            <div class="mt-3 flex flex-wrap gap-4">
                <div class="legend-item"><div class="legend-swatch" style="background:#9CA3AF"></div> Preventivato</div>
                <div class="legend-item"><div class="legend-swatch" style="background:#3B82F6"></div> Approvato</div>
                <div class="legend-item"><div class="legend-swatch" style="background:#F59E0B"></div> In Corso</div>
                <div class="legend-item"><div class="legend-swatch" style="background:#EF4444"></div> Attesa Ricambi</div>
                <div class="legend-item"><div class="legend-swatch" style="background:#8B5CF6"></div> Ispezione</div>
                <div class="legend-item"><div class="legend-swatch" style="background:#10B981"></div> Completato</div>
                <div class="legend-item"><div class="legend-swatch striped"></div> In Attesa</div>
            </div>
        </div>

        <!-- Loading -->
        <div x-show="loading" class="text-center py-12">
            <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-amber-600 mx-auto mb-4"></div>
            <p class="text-gray-500">Caricamento timeline...</p>
        </div>

        <!-- Timeline Grid -->
        <div x-show="!loading" class="card p-0 overflow-x-auto">
            <!-- Rendered via JS into this container -->
            <div id="timeline-container"></div>

            <!-- Empty state -->
            <div x-show="timeline.length === 0 && !loading" class="p-12 text-center">
                <p class="text-gray-400 text-lg">Nessuna piazzola configurata</p>
                <p class="text-gray-400 text-sm mt-2">Aggiungi piazzole tramite l'API per vedere la timeline</p>
            </div>
        </div>
    </main>
</div>

<script>
function bayTimelineData() {
    return {
        user: { username: '' },
        token: '',
        loading: true,
        timeline: [],
        days: [],
        weekStart: null,

        get gridStyle() {
            // 1 column for bay label + 7 columns for days
            return `grid-template-columns: 140px repeat(7, minmax(100px, 1fr));`;
        },

        get dateRangeLabel() {
            if (this.days.length < 7) return '';
            return this.days[0].label + ' - ' + this.days[6].label;
        },

        init() {
            // Get token from URL hash or localStorage
            const hash = window.location.hash;
            if (hash.includes('token=')) {
                this.token = hash.split('token=')[1];
                localStorage.setItem('camper_token', this.token);
                history.replaceState(null, '', window.location.pathname);
            } else {
                this.token = localStorage.getItem('camper_token') || '';
            }

            if (!this.token) {
                window.location.href = '/camper';
                return;
            }

            try {
                const payload = JSON.parse(atob(this.token.split('.')[1]));
                this.user.username = payload.preferred_username || payload.sub || 'utente';
            } catch(e) {
                this.user.username = 'utente';
            }

            this.thisWeek();
        },

        buildDays() {
            const dayNames = ['Lun', 'Mar', 'Mer', 'Gio', 'Ven', 'Sab', 'Dom'];
            const months = ['Gen', 'Feb', 'Mar', 'Apr', 'Mag', 'Giu', 'Lug', 'Ago', 'Set', 'Ott', 'Nov', 'Dic'];
            const today = new Date();
            today.setHours(0,0,0,0);

            this.days = [];
            for (let i = 0; i < 7; i++) {
                const d = new Date(this.weekStart);
                d.setDate(d.getDate() + i);
                const iso = d.toISOString().split('T')[0];
                const dayOfWeek = d.getDay();
                this.days.push({
                    iso: iso,
                    dayName: dayNames[i],
                    dayNum: d.getDate(),
                    label: d.getDate() + ' ' + months[d.getMonth()],
                    isToday: d.getTime() === today.getTime(),
                    isWeekend: dayOfWeek === 0 || dayOfWeek === 6,
                });
            }
        },

        thisWeek() {
            const today = new Date();
            const day = today.getDay();
            const diff = today.getDate() - day + (day === 0 ? -6 : 1); // Monday
            this.weekStart = new Date(today.setDate(diff));
            this.weekStart.setHours(0,0,0,0);
            this.buildDays();
            this.fetchTimeline();
        },

        prevWeek() {
            this.weekStart.setDate(this.weekStart.getDate() - 7);
            this.buildDays();
            this.fetchTimeline();
        },

        nextWeek() {
            this.weekStart.setDate(this.weekStart.getDate() + 7);
            this.buildDays();
            this.fetchTimeline();
        },

        async fetchTimeline() {
            this.loading = true;
            const startIso = this.days[0].iso;
            const endIso = this.days[6].iso;

            try {
                const resp = await fetch(`/api/v1/camper/bay-timeline?start=${startIso}&end=${endIso}`, {
                    headers: { 'Authorization': 'Bearer ' + this.token }
                });
                if (resp.status === 401 || resp.status === 403) {
                    window.location.href = '/camper';
                    return;
                }
                this.timeline = await resp.json();
            } catch(e) {
                console.error('Failed to fetch bay timeline:', e);
                this.timeline = [];
            }
            this.loading = false;
            this.$nextTick(() => this.renderGrid());
        },

        renderGrid() {
            const container = document.getElementById('timeline-container');
            if (!container) return;
            container.innerHTML = '';

            if (this.timeline.length === 0) return;

            const grid = document.createElement('div');
            grid.className = 'timeline-grid';
            grid.style.cssText = `display:grid; grid-template-columns: 140px repeat(7, minmax(100px, 1fr)); gap:0;`;

            // Header row
            const corner = document.createElement('div');
            corner.className = 'bay-label';
            corner.style.cssText = 'border-bottom: 2px solid #e5e7eb; font-size: 0.7rem; color: #9ca3af;';
            corner.textContent = 'PIAZZOLA';
            grid.appendChild(corner);

            const todayIso = new Date().toISOString().split('T')[0];

            for (const day of this.days) {
                const hdr = document.createElement('div');
                hdr.className = 'timeline-header' + (day.isToday ? ' today' : '') + (day.isWeekend ? ' weekend' : '');
                hdr.innerHTML = `<div>${day.dayName}</div><div class="text-base font-bold ${day.isToday ? 'text-amber-700' : 'text-gray-800'}">${day.dayNum}</div>`;
                grid.appendChild(hdr);
            }

            // Bay rows
            for (const bay of this.timeline) {
                // Bay label
                const label = document.createElement('div');
                label.className = 'bay-label';
                label.innerHTML = `<span>${bay.bay_name}</span><span class="bay-type">${bay.bay_type}</span>`;
                grid.appendChild(label);

                // Day cells
                for (let di = 0; di < this.days.length; di++) {
                    const day = this.days[di];
                    const cell = document.createElement('div');
                    cell.className = 'bay-cell' + (day.isToday ? ' today' : '') + (day.isWeekend ? ' weekend' : '');

                    // Find entries that should start rendering in this cell
                    for (const entry of bay.entries) {
                        const firstDay = this.days[0].iso;
                        const visibleStart = entry.start_date < firstDay ? firstDay : entry.start_date;
                        if (visibleStart !== day.iso) continue;

                        const visibleEnd = entry.end_date > this.days[6].iso ? this.days[6].iso : entry.end_date;
                        const startIdx = this.days.findIndex(d => d.iso === visibleStart);
                        const endIdx = this.days.findIndex(d => d.iso === visibleEnd);
                        const span = Math.max(1, endIdx - startIdx + 1);
                        const widthPct = span <= 1 ? 96 : (span * 100 - 4);

                        const bar = document.createElement('a');
                        bar.href = '/camper/jobs/' + entry.job_id;
                        bar.className = 'job-bar' + (entry.wait_reason ? ' waiting' : '');
                        bar.style.cssText = `background-color:${entry.color}; width:${widthPct}%;`;
                        bar.title = entry.job_number + ' - ' + entry.vehicle_plate +
                            ' (' + entry.customer_name + ')' +
                            (entry.wait_reason ? ' [ATTESA: ' + entry.wait_reason + ']' : '');
                        bar.innerHTML = `<span class="job-plate">${entry.vehicle_plate}</span><span class="job-title">${entry.job_number}</span>`;
                        cell.appendChild(bar);
                    }

                    grid.appendChild(cell);
                }
            }

            container.appendChild(grid);
        },

        logout() {
            localStorage.removeItem('camper_token');
            window.location.href = '/camper';
        }
    };
}
</script>
{% endblock %}
