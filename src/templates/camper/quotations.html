{% extends "camper/base.html" %}

{% block title %}Preventivi - Camper & Tour{% endblock %}
{% block page_name %}Preventivi{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50" x-data="quotationsData()">
    <!-- Top Navigation -->
    <nav class="bg-white shadow-lg sticky top-0 z-10">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center space-x-4">
                    <span class="text-2xl">&#x1F69C;</span>
                    <div>
                        <h1 class="text-xl font-bold text-gray-900">Camper & Tour</h1>
                        <p class="text-xs text-gray-500">Gestione Servizi</p>
                    </div>
                </div>

                <!-- Nav Links -->
                <div class="hidden md:flex items-center space-x-2">
                    <a href="/camper/dashboard" class="px-3 py-2 rounded-lg text-sm font-medium text-gray-600 hover:bg-gray-100">Cruscotto</a>
                    <a href="/camper/checkin" class="px-3 py-2 rounded-lg text-sm font-medium text-gray-600 hover:bg-gray-100">Accettazione</a>
                    <a href="/camper/jobs" class="px-3 py-2 rounded-lg text-sm font-medium text-gray-600 hover:bg-gray-100">Lavori</a>
                    <a href="/camper/customers" class="px-3 py-2 rounded-lg text-sm font-medium text-gray-600 hover:bg-gray-100">Clienti</a>
                    <a href="/camper/quotations" class="px-3 py-2 rounded-lg text-sm font-medium bg-amber-100 text-amber-800">Preventivi</a>
                    <a href="/camper/purchase-orders" class="px-3 py-2 rounded-lg text-sm font-medium text-gray-600 hover:bg-gray-100">Ordini Acquisto</a>
                    <a href="/camper/invoices" class="px-3 py-2 rounded-lg text-sm font-medium text-gray-600 hover:bg-gray-100">Fatture</a>
                    <a href="/camper/calendar" class="px-3 py-2 rounded-lg text-sm font-medium text-gray-600 hover:bg-gray-100">Calendario</a>
                </div>

                <div class="flex items-center space-x-3">
                    <span class="text-sm text-gray-600" x-text="user.username"></span>
                    <button @click="CamperAuth.logout()" class="text-red-600 hover:text-red-700 text-sm">Esci</button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Mobile Nav -->
    <div class="md:hidden bg-white border-b px-4 py-2 flex space-x-2 overflow-x-auto">
        <a href="/camper/dashboard" class="px-3 py-1.5 rounded-lg text-xs font-medium text-gray-600 bg-gray-50 whitespace-nowrap">Cruscotto</a>
        <a href="/camper/checkin" class="px-3 py-1.5 rounded-lg text-xs font-medium text-gray-600 bg-gray-50 whitespace-nowrap">Accettazione</a>
        <a href="/camper/jobs" class="px-3 py-1.5 rounded-lg text-xs font-medium text-gray-600 bg-gray-50 whitespace-nowrap">Lavori</a>
        <a href="/camper/customers" class="px-3 py-1.5 rounded-lg text-xs font-medium text-gray-600 bg-gray-50 whitespace-nowrap">Clienti</a>
        <a href="/camper/quotations" class="px-3 py-1.5 rounded-lg text-xs font-medium bg-amber-100 text-amber-800 whitespace-nowrap">Preventivi</a>
        <a href="/camper/purchase-orders" class="px-3 py-1.5 rounded-lg text-xs font-medium text-gray-600 bg-gray-50 whitespace-nowrap">Ordini Acquisto</a>
        <a href="/camper/invoices" class="px-3 py-1.5 rounded-lg text-xs font-medium text-gray-600 bg-gray-50 whitespace-nowrap">Fatture</a>
        <a href="/camper/calendar" class="px-3 py-1.5 rounded-lg text-xs font-medium text-gray-600 bg-gray-50 whitespace-nowrap">Calendario</a>
    </div>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
        <!-- Header + New Quotation -->
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-bold text-gray-900">Preventivi</h2>
            <a href="/camper/quotations/new" class="btn-primary" x-show="user.isManager">
                + Nuovo Preventivo
            </a>
        </div>

        <!-- Filters -->
        <div class="card mb-6">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <label class="block text-xs font-medium text-gray-500 mb-1">Stato</label>
                    <select x-model="filters.status" @change="loadQuotations()" class="input-field text-sm py-2">
                        <option value="">Tutti</option>
                        <option value="draft">Bozza</option>
                        <option value="sent">Inviato</option>
                        <option value="accepted">Accettato</option>
                        <option value="rejected">Rifiutato</option>
                        <option value="expired">Scaduto</option>
                    </select>
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-500 mb-1">Cliente</label>
                    <select x-model="filters.customer_id" @change="loadQuotations()" class="input-field text-sm py-2">
                        <option value="">Tutti</option>
                        <template x-for="c in customerList" :key="c.id">
                            <option :value="c.id" x-text="c.name"></option>
                        </template>
                    </select>
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-500 mb-1">Cerca (n. preventivo)</label>
                    <input type="text" x-model="filters.search" @input.debounce.300ms="applySearch()"
                           class="input-field text-sm py-2" placeholder="QUO-...">
                </div>
            </div>
        </div>

        <!-- Quotation Count -->
        <p class="text-sm text-gray-500 mb-3" x-show="!loading">
            <span x-text="filteredQuotations.length"></span> preventivi trovati
        </p>

        <!-- Quotations Table -->
        <div class="card overflow-x-auto">
            <template x-if="loading">
                <p class="text-center text-gray-500 py-8">Caricamento...</p>
            </template>

            <template x-if="!loading && filteredQuotations.length === 0">
                <p class="text-center text-gray-500 py-8">Nessun preventivo trovato.</p>
            </template>

            <table class="min-w-full" x-show="!loading && filteredQuotations.length > 0">
                <thead>
                    <tr class="border-b text-left text-xs font-medium text-gray-500 uppercase">
                        <th class="pb-3 pr-4">Numero</th>
                        <th class="pb-3 pr-4">Cliente</th>
                        <th class="pb-3 pr-4">Totale</th>
                        <th class="pb-3 pr-4">Acconto</th>
                        <th class="pb-3 pr-4">Stato</th>
                        <th class="pb-3 pr-4">Data</th>
                        <th class="pb-3">Azioni</th>
                    </tr>
                </thead>
                <tbody>
                    <template x-for="q in filteredQuotations" :key="q.id">
                        <tr class="border-b hover:bg-amber-50 cursor-pointer transition"
                            @click="window.location.href='/camper/quotations/' + q.id">
                            <td class="py-3 pr-4 text-sm font-mono text-gray-700" x-text="q.quote_number"></td>
                            <td class="py-3 pr-4 text-sm font-semibold text-gray-900" x-text="customerMap[q.customer_id] || '...'"></td>
                            <td class="py-3 pr-4 text-sm text-gray-700" x-text="formatPrice(q.total)"></td>
                            <td class="py-3 pr-4 text-sm text-gray-600" x-text="formatPrice(q.deposit_amount)"></td>
                            <td class="py-3 pr-4">
                                <span class="badge"
                                      :class="statusBadgeClass(q.status)"
                                      :style="q.status === 'rejected' ? 'text-decoration: line-through;' : ''"
                                      x-text="statusLabel(q.status)"></span>
                            </td>
                            <td class="py-3 pr-4 text-sm text-gray-500" x-text="formatDate(q.created_at)"></td>
                            <td class="py-3" @click.stop>
                                <div class="flex items-center space-x-2">
                                    <template x-if="q.status === 'draft'">
                                        <button @click="sendQuotation(q.id)"
                                                class="text-blue-600 hover:text-blue-800 text-xs font-medium"
                                                title="Invia al cliente">
                                            Invia
                                        </button>
                                    </template>
                                    <template x-if="q.status === 'draft' || q.status === 'sent'">
                                        <button @click="acceptQuotation(q.id)"
                                                class="text-green-600 hover:text-green-800 text-xs font-medium"
                                                title="Accetta preventivo">
                                            Accetta
                                        </button>
                                    </template>
                                    <template x-if="q.status === 'draft' || q.status === 'sent'">
                                        <button @click="rejectQuotation(q.id)"
                                                class="text-red-600 hover:text-red-800 text-xs font-medium"
                                                title="Rifiuta preventivo">
                                            Rifiuta
                                        </button>
                                    </template>
                                    <template x-if="q.status === 'accepted' || q.status === 'rejected' || q.status === 'expired'">
                                        <span class="text-xs text-gray-400">-</span>
                                    </template>
                                </div>
                            </td>
                        </tr>
                    </template>
                </tbody>
            </table>
        </div>
    </main>
</div>

<script>
    function quotationsData() {
        return {
            user: {
                username: '', firstName: '', roles: [],
                isAdmin: false, isManager: false, isMechanic: false, isCounter: false
            },
            quotations: [],
            customerMap: {},
            customerList: [],
            filters: { status: '', customer_id: '', search: '' },
            loading: true,

            // Status label mapping (Italian)
            statusLabel(status) {
                const labels = {
                    'draft': 'Bozza',
                    'sent': 'Inviato',
                    'accepted': 'Accettato',
                    'rejected': 'Rifiutato',
                    'expired': 'Scaduto'
                };
                return labels[status] || status;
            },

            // Status badge class mapping
            statusBadgeClass(status) {
                const classes = {
                    'draft': 'badge-quoted',
                    'sent': 'badge-approved',
                    'accepted': 'badge-completed',
                    'rejected': 'badge-cancelled',
                    'expired': 'badge-waiting_parts'
                };
                return classes[status] || 'badge-quoted';
            },

            get filteredQuotations() {
                let result = this.quotations;
                if (this.filters.search) {
                    const q = this.filters.search.toLowerCase();
                    result = result.filter(item =>
                        item.quote_number.toLowerCase().includes(q) ||
                        (this.customerMap[item.customer_id] || '').toLowerCase().includes(q)
                    );
                }
                return result;
            },

            init() {
                const token = CamperAuth.getToken();
                if (!token) { window.location.href = '/camper'; return; }
                const userInfo = CamperAuth.getUserInfo();
                if (!userInfo || userInfo.roles.length === 0) { CamperAuth.logout(); return; }
                this.user = {
                    ...userInfo,
                    isAdmin: CamperAuth.isAdmin(),
                    isManager: CamperAuth.isManager(),
                    isMechanic: CamperAuth.isMechanic(),
                    isCounter: CamperAuth.isCounter()
                };

                // Check URL params for filters
                const params = new URLSearchParams(window.location.search);
                if (params.get('status')) this.filters.status = params.get('status');
                if (params.get('customer_id')) this.filters.customer_id = params.get('customer_id');

                this.loadCustomers();
                this.loadQuotations();
            },

            async loadCustomers() {
                try {
                    const customers = await API.get('/api/v1/camper/customers');
                    this.customerList = customers;
                    customers.forEach(c => { this.customerMap[c.id] = c.name; });
                } catch (e) {
                    console.error('Customer load failed:', e);
                }
            },

            async loadQuotations() {
                this.loading = true;
                try {
                    let url = '/api/v1/camper/quotations?limit=200';
                    if (this.filters.status) url += '&status_filter=' + this.filters.status;
                    if (this.filters.customer_id) url += '&customer_id=' + this.filters.customer_id;
                    this.quotations = await API.get(url);
                } catch (e) {
                    showToast('Errore caricamento preventivi: ' + e.message, 'error');
                } finally {
                    this.loading = false;
                }
            },

            applySearch() {
                // Client-side filtering via the computed filteredQuotations getter
                // No API call needed - just triggers Alpine reactivity
            },

            async sendQuotation(quotationId) {
                if (!confirm('Inviare il preventivo al cliente?')) return;
                try {
                    const updated = await API.post('/api/v1/camper/quotations/' + quotationId + '/send');
                    const idx = this.quotations.findIndex(q => q.id === quotationId);
                    if (idx >= 0) this.quotations[idx] = updated;
                    showToast('Preventivo inviato!', 'success');
                } catch (e) {
                    showToast('Errore: ' + e.message, 'error');
                }
            },

            async acceptQuotation(quotationId) {
                if (!confirm('Accettare il preventivo? Il lavoro sara approvato e l\'acconto calcolato.')) return;
                try {
                    const updated = await API.post('/api/v1/camper/quotations/' + quotationId + '/accept');
                    const idx = this.quotations.findIndex(q => q.id === quotationId);
                    if (idx >= 0) this.quotations[idx] = updated;
                    showToast('Preventivo accettato! Acconto: ' + formatPrice(updated.deposit_amount), 'success');
                } catch (e) {
                    showToast('Errore: ' + e.message, 'error');
                }
            },

            async rejectQuotation(quotationId) {
                const reason = prompt('Motivo del rifiuto (opzionale):');
                if (reason === null) return; // User cancelled
                try {
                    let url = '/api/v1/camper/quotations/' + quotationId + '/reject';
                    if (reason) url += '?reason=' + encodeURIComponent(reason);
                    const updated = await API.post(url);
                    const idx = this.quotations.findIndex(q => q.id === quotationId);
                    if (idx >= 0) this.quotations[idx] = updated;
                    showToast('Preventivo rifiutato.', 'info');
                } catch (e) {
                    showToast('Errore: ' + e.message, 'error');
                }
            }
        }
    }
</script>
{% endblock %}
