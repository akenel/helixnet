{% extends "pos/base.html" %}

{% block title %}Checkout - HelixPOS{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50" x-data="checkoutData()">
    <div class="max-w-4xl mx-auto px-4 py-8">
        <div class="card">
            <h1 class="text-3xl font-bold text-gray-900 mb-6">üí≥ Checkout</h1>

            <!-- Order Summary -->
            <div class="mb-6">
                <h2 class="text-xl font-semibold text-gray-900 mb-4">Order Summary</h2>
                <div class="bg-gray-50 rounded-lg p-4 space-y-2">
                    <template x-for="(item, index) in cartData.cart" :key="index">
                        <div class="flex justify-between">
                            <span x-text="`${item.quantity}x ${item.name}`"></span>
                            <span x-text="formatPrice(item.price * item.quantity)"></span>
                        </div>
                    </template>
                </div>
            </div>

            <!-- üè∑Ô∏è Quick Discount (Pam's Rounding) -->
            <div class="mb-6">
                <h2 class="text-xl font-semibold text-gray-900 mb-4">üè∑Ô∏è Discount</h2>
                <div class="grid grid-cols-5 gap-2">
                    <button @click="applyDiscount(0)" :class="discount === 0 ? 'bg-gray-300' : 'bg-gray-100'" class="btn-secondary py-3">None</button>
                    <button @click="applyDiscount(5)" :class="discount === 5 ? 'bg-green-300' : 'bg-green-100'" class="btn-secondary py-3">5%</button>
                    <button @click="applyDiscount(10)" :class="discount === 10 ? 'bg-green-300' : 'bg-green-100'" class="btn-secondary py-3">10%</button>
                    <button @click="applyDiscount(15)" :class="discount === 15 ? 'bg-yellow-300' : 'bg-yellow-100'" class="btn-secondary py-3">15%</button>
                    <button @click="customDiscount()" class="btn-secondary py-3 bg-blue-100">Custom</button>
                </div>
                <p class="text-sm text-gray-500 mt-2">üí° Cashiers: max 10% | Managers: max 25% | Admin: unlimited</p>
            </div>

            <!-- Price Breakdown -->
            <div class="bg-indigo-50 rounded-lg p-6 mb-6 space-y-3">
                <div class="flex justify-between">
                    <span>Subtotal:</span>
                    <span x-text="formatPrice(cartData.totals.subtotal)"></span>
                </div>
                <div x-show="discount > 0" class="flex justify-between text-green-600">
                    <span>Discount (<span x-text="discount"></span>%):</span>
                    <span x-text="'-' + formatPrice(discountAmount)"></span>
                </div>
                <div class="flex justify-between">
                    <span>VAT (<span x-text="POSConfig.vat_rate"></span>%):</span>
                    <span x-text="formatPrice(cartData.totals.vat)"></span>
                </div>
                <div class="border-t pt-3 flex justify-between text-xl font-bold">
                    <span>TOTAL:</span>
                    <span class="text-indigo-600" x-text="formatPrice(cartData.totals.total)"></span>
                </div>
            </div>

            <!-- Payment Method -->
            <div class="mb-6">
                <h2 class="text-xl font-semibold text-gray-900 mb-4">üí∞ Payment Method</h2>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <button
                        @click="selectPayment('cash')"
                        :class="paymentMethod === 'cash' ? 'border-4 border-green-500' : 'border-2 border-gray-300'"
                        class="card py-6 text-center cursor-pointer hover:shadow-lg transition">
                        <span class="text-4xl mb-2 block">üíµ</span>
                        <p class="font-semibold">Cash</p>
                    </button>
                    <button
                        @click="selectPayment('visa')"
                        :class="paymentMethod === 'visa' ? 'border-4 border-green-500' : 'border-2 border-gray-300'"
                        class="card py-6 text-center cursor-pointer hover:shadow-lg transition">
                        <span class="text-4xl mb-2 block">üí≥</span>
                        <p class="font-semibold">Visa/MC</p>
                    </button>
                    <button
                        @click="selectPayment('debit')"
                        :class="paymentMethod === 'debit' ? 'border-4 border-green-500' : 'border-2 border-gray-300'"
                        class="card py-6 text-center cursor-pointer hover:shadow-lg transition">
                        <span class="text-4xl mb-2 block">üè¶</span>
                        <p class="font-semibold">Debit</p>
                    </button>
                    <button
                        @click="selectPayment('twint')"
                        :class="paymentMethod === 'twint' ? 'border-4 border-green-500' : 'border-2 border-gray-300'"
                        class="card py-6 text-center cursor-pointer hover:shadow-lg transition">
                        <span class="text-4xl mb-2 block">üì±</span>
                        <p class="font-semibold">TWINT</p>
                    </button>
                </div>
            </div>

            <!-- üíµ CASH QUICK ROUND (Only shows for CASH payments) -->
            <div x-show="paymentMethod === 'cash'" x-transition class="mb-6">
                <h2 class="text-xl font-semibold text-gray-900 mb-4">üíµ Cash Received</h2>

                <!-- Quick Amount Buttons -->
                <div class="grid grid-cols-5 gap-2 mb-4">
                    <button @click="setCashReceived(10)"
                        :class="cashReceived === 10 ? 'bg-green-500 text-white' : 'bg-green-100'"
                        class="btn-secondary py-3 font-bold">10</button>
                    <button @click="setCashReceived(20)"
                        :class="cashReceived === 20 ? 'bg-green-500 text-white' : 'bg-green-100'"
                        class="btn-secondary py-3 font-bold">20</button>
                    <button @click="setCashReceived(50)"
                        :class="cashReceived === 50 ? 'bg-green-500 text-white' : 'bg-green-100'"
                        class="btn-secondary py-3 font-bold">50</button>
                    <button @click="setCashReceived(100)"
                        :class="cashReceived === 100 ? 'bg-green-500 text-white' : 'bg-green-100'"
                        class="btn-secondary py-3 font-bold">100</button>
                    <button @click="setCashReceived(cartData.totals.total)"
                        :class="cashReceived === cartData.totals.total ? 'bg-blue-500 text-white' : 'bg-blue-100'"
                        class="btn-secondary py-3 font-bold">EXACT</button>
                </div>

                <!-- Cash Received Display -->
                <div x-show="cashReceived > 0" class="bg-green-50 rounded-lg p-4 mb-4">
                    <div class="flex justify-between text-lg">
                        <span>Cash Received:</span>
                        <span class="font-bold text-green-700" x-text="'CHF ' + cashReceived.toFixed(2)"></span>
                    </div>
                    <div class="flex justify-between text-lg">
                        <span>Total Due:</span>
                        <span x-text="formatPrice(cartData.totals.total)"></span>
                    </div>
                    <div class="flex justify-between text-lg border-t pt-2 mt-2">
                        <span>Change:</span>
                        <span class="font-bold" :class="changeAmount >= 0 ? 'text-green-700' : 'text-red-600'"
                              x-text="'CHF ' + changeAmount.toFixed(2)"></span>
                    </div>
                </div>

                <!-- Quick Round Options (when there's a small gap) -->
                <div x-show="cashReceived > 0 && changeGap > 0 && changeGap <= 2" class="mb-4">
                    <h3 class="text-md font-semibold text-gray-700 mb-2">üéØ Quick Round Options</h3>
                    <div class="grid grid-cols-2 gap-2">
                        <button @click="applyQuickRound()"
                            class="bg-yellow-100 hover:bg-yellow-200 p-3 rounded-lg text-left">
                            <span class="block font-bold text-yellow-800">Round to <span x-text="'CHF ' + cashReceived.toFixed(2)"></span></span>
                            <span class="text-sm text-yellow-600">Give back CHF <span x-text="Math.floor(changeAmount).toFixed(2)"></span> (clean notes)</span>
                        </button>
                        <button @click="showChangeProducts = !showChangeProducts"
                            class="bg-pink-100 hover:bg-pink-200 p-3 rounded-lg text-left">
                            <span class="block font-bold text-pink-800">üç≠ Add Small Item</span>
                            <span class="text-sm text-pink-600">Keep the change, give a treat!</span>
                        </button>
                    </div>
                </div>

                <!-- Product-as-Change (Pink Punch Model) -->
                <div x-show="showChangeProducts && changeGap > 0" x-transition class="bg-pink-50 rounded-lg p-4 mb-4">
                    <h3 class="text-md font-semibold text-pink-800 mb-3">üç≠ Change Products (under CHF <span x-text="changeGap.toFixed(2)"></span>)</h3>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
                        <template x-for="product in changeProducts" :key="product.name">
                            <button @click="addChangeProduct(product)"
                                class="bg-white hover:bg-pink-100 p-2 rounded border text-center">
                                <span class="block text-2xl" x-text="product.emoji"></span>
                                <span class="block text-sm font-semibold" x-text="product.name"></span>
                                <span class="block text-xs text-gray-500" x-text="'CHF ' + product.price.toFixed(2)"></span>
                            </button>
                        </template>
                    </div>
                    <p class="text-xs text-pink-600 mt-2">Customer gets a treat, you keep cleaner change!</p>
                </div>
            </div>

            <!-- Dry Run Preview -->
            <div class="bg-yellow-50 border-2 border-yellow-400 rounded-lg p-6 mb-6">
                <h2 class="text-lg font-semibold text-yellow-800 mb-3">‚ö†Ô∏è Dry Run Preview</h2>
                <div class="space-y-2 text-sm text-yellow-900">
                    <p>‚Ä¢ Cash drawer: <span x-text="paymentMethod === 'cash' ? '+' + formatPrice(cartData.totals.total) : 'CHF 0.00 (electronic)'"></span></p>
                    <p>‚Ä¢ Inventory: <span x-text="inventoryPreview()"></span></p>
                    <p>‚Ä¢ Receipt: Will print to POS printer</p>
                    <p>‚Ä¢ Daily total: +<span x-text="formatPrice(cartData.totals.total)"></span></p>
                </div>
            </div>

            <!-- Confirmation -->
            <div class="mb-6 text-center">
                <p class="text-lg text-gray-700">‚ùì Does everything look correct?</p>
            </div>

            <!-- Action Buttons -->
            <div class="grid grid-cols-3 gap-4">
                <button @click="goBack()" class="btn-secondary">
                    ‚ùå Cancel
                </button>
                <button @click="goBack()" class="btn-secondary">
                    ‚úèÔ∏è Edit Cart
                </button>
                <button @click="completeTransaction()" :disabled="processing" class="btn-success">
                    <span x-show="!processing">‚úÖ Confirm & Complete</span>
                    <span x-show="processing">Processing...</span>
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    function checkoutData() {
        return {
            cartData: {cart: [], totals: {}, discount: 0, transactionId: ''},
            paymentMethod: 'visa',
            processing: false,
            discount: 0,
            discountAmount: 0,

            // Cash Quick Round
            cashReceived: 0,
            changeAmount: 0,
            changeGap: 0,
            showChangeProducts: false,
            quickRoundApplied: false,

            // Product-as-Change defaults (configurable per store)
            changeProducts: [
                { name: 'Lollipop', emoji: 'üç≠', price: 0.50 },
                { name: 'CBD Gummy', emoji: 'üç¨', price: 0.45 },
                { name: 'Papers', emoji: 'üìÑ', price: 0.60 },
                { name: 'Sticker', emoji: '‚ú®', price: 0.30 },
                { name: 'Lighter', emoji: 'üî•', price: 1.50 },
                { name: 'Grinder Card', emoji: 'üÉè', price: 1.80 }
            ],

            init() {
                const stored = sessionStorage.getItem('pos_cart');
                if (!stored) {
                    showToast('No cart data found', 'warning');
                    setTimeout(() => window.location.href = '/pos/scan', 1000);
                    return;
                }

                this.cartData = JSON.parse(stored);
                this.discount = this.cartData.discount || 0;
                this.recalculateTotals();
            },

            selectPayment(method) {
                this.paymentMethod = method;
                // Reset cash fields when switching payment method
                if (method !== 'cash') {
                    this.cashReceived = 0;
                    this.changeAmount = 0;
                    this.changeGap = 0;
                    this.showChangeProducts = false;
                    this.quickRoundApplied = false;
                }
            },

            setCashReceived(amount) {
                this.cashReceived = amount;
                this.calculateChange();
            },

            calculateChange() {
                const total = this.cartData.totals.total;
                this.changeAmount = this.cashReceived - total;
                // Gap is the cents part that could be rounded
                this.changeGap = this.changeAmount > 0 ? (this.changeAmount % 1) : Math.abs(this.changeAmount);

                // Filter change products to only show affordable ones
                if (this.changeGap > 0) {
                    this.changeProducts = this.changeProducts.filter(p => p.price <= this.changeGap + 0.50);
                }
            },

            applyQuickRound() {
                // Round total UP to match cash received (customer gets clean change)
                const total = this.cartData.totals.total;
                const roundedTotal = this.cashReceived - Math.floor(this.changeAmount);

                // Calculate the discount needed to reach rounded total
                // Reverse engineer: new_total = (subtotal - discount) * (1 + vat_rate)
                // So: subtotal - discount = new_total / (1 + vat_rate)
                const vatMultiplier = 1 + (POSConfig.vat_rate / 100);
                const netAfterRound = roundedTotal / vatMultiplier;
                const subtotal = this.cartData.totals.subtotal;
                const roundDiscount = subtotal - netAfterRound;

                // Apply as a discount amount (not percentage)
                this.cartData.totals.roundDiscount = roundDiscount;
                this.cartData.totals.total = roundedTotal;
                this.cartData.totals.vat = roundedTotal - netAfterRound;

                this.quickRoundApplied = true;
                this.calculateChange();
                sessionStorage.setItem('pos_cart', JSON.stringify(this.cartData));
                showToast(`Rounded to CHF ${roundedTotal.toFixed(2)} - clean change!`, 'success');
            },

            addChangeProduct(product) {
                // Add product to cart as "change product"
                this.cartData.cart.push({
                    id: 'change_' + Date.now(),
                    name: product.name + ' (Change)',
                    price: product.price,
                    quantity: 1,
                    isChangeProduct: true
                });

                // Recalculate totals with the new item
                this.cartData.totals.subtotal += product.price;
                this.recalculateTotals();
                this.calculateChange();
                this.showChangeProducts = false;

                sessionStorage.setItem('pos_cart', JSON.stringify(this.cartData));
                showToast(`Added ${product.emoji} ${product.name} - customer gets a treat!`, 'success');
            },

            applyDiscount(percent) {
                // TODO: Check user role for max discount
                this.discount = percent;
                this.cartData.discount = percent;
                this.recalculateTotals();
                this.calculateChange(); // Recalculate change after discount
                sessionStorage.setItem('pos_cart', JSON.stringify(this.cartData));
                showToast(`${percent}% discount applied`, 'success');
            },

            customDiscount() {
                const custom = prompt('Enter discount percentage (0-25):');
                if (custom !== null) {
                    const percent = Math.min(25, Math.max(0, parseInt(custom) || 0));
                    this.applyDiscount(percent);
                }
            },

            recalculateTotals() {
                const subtotal = this.cartData.totals.subtotal || 0;
                this.discountAmount = subtotal * (this.discount / 100);
                const afterDiscount = subtotal - this.discountAmount;
                // VAT calculated AFTER discount (Swiss compliant)
                const vat = afterDiscount * POSConfig.vat_decimal;
                this.cartData.totals.discountAmount = this.discountAmount;
                this.cartData.totals.vat = vat;
                this.cartData.totals.total = afterDiscount + vat;
            },

            inventoryPreview() {
                const counts = {};
                this.cartData.cart.forEach(item => {
                    if (!item.isCatalogItem) {
                        counts[item.name] = (counts[item.name] || 0) + item.quantity;
                    }
                });
                return Object.entries(counts).map(([name, qty]) => `-${qty} ${name}`).join(', ') || 'No inventory changes';
            },

            async completeTransaction() {
                if (!this.paymentMethod) {
                    showToast('Please select a payment method', 'warning');
                    return;
                }

                // For cash payments, require cash received amount
                if (this.paymentMethod === 'cash' && this.cashReceived <= 0) {
                    showToast('Please select cash amount received', 'warning');
                    return;
                }

                // For cash, show change in confirmation
                let confirmMsg = `Complete transaction for ${formatPrice(this.cartData.totals.total)}?`;
                if (this.paymentMethod === 'cash' && this.changeAmount > 0) {
                    confirmMsg += `\n\nCash received: CHF ${this.cashReceived.toFixed(2)}\nChange to give: CHF ${this.changeAmount.toFixed(2)}`;
                }

                if (!confirm(confirmMsg)) {
                    return;
                }

                this.processing = true;

                try {
                    // Create transaction
                    const transaction = await API.post('/api/v1/pos/transactions', {});

                    // Add line items
                    for (const item of this.cartData.cart) {
                        await API.post(`/api/v1/pos/transactions/${transaction.id}/items`, {
                            product_id: item.id.toString().startsWith('catalog') || item.id.toString().startsWith('change_') ? null : item.id,
                            quantity: item.quantity,
                            unit_price: item.price.toString(),
                            discount_percent: this.cartData.discount.toString()
                        });
                    }

                    // Checkout - cash payments use the pre-selected amount
                    const checkoutData = {
                        payment_method: this.paymentMethod
                    };
                    if (this.paymentMethod === 'cash') {
                        // Use the cash received from Quick Round buttons
                        checkoutData.amount_tendered = this.cashReceived.toFixed(2);
                    }
                    await API.post(`/api/v1/pos/transactions/${transaction.id}/checkout`, checkoutData);

                    // Clear cart
                    sessionStorage.removeItem('pos_cart');

                    showToast('Transaction completed! Displaying receipt...', 'success');

                    // Redirect to receipt page
                    setTimeout(() => {
                        window.location.href = `/pos/receipt/${transaction.id}`;
                    }, 500);

                } catch (error) {
                    showToast('Error: ' + error.message, 'error');
                    this.processing = false;
                }
            },

            goBack() {
                window.location.href = '/pos/scan';
            },

            formatPrice(amount) {
                return formatPrice(amount);
            }
        }
    }
</script>
{% endblock %}
