{% extends "pos/base.html" %}

{% block title %}Checkout - HelixPOS{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50" x-data="checkoutData()">
    <div class="max-w-4xl mx-auto px-4 py-8">
        <div class="card">
            <h1 class="text-3xl font-bold text-gray-900 mb-6">üí≥ Checkout</h1>

            <!-- Order Summary -->
            <div class="mb-6">
                <h2 class="text-xl font-semibold text-gray-900 mb-4">Order Summary</h2>
                <div class="bg-gray-50 rounded-lg p-4 space-y-2">
                    <template x-for="(item, index) in cartData.cart" :key="index">
                        <div class="flex justify-between">
                            <span x-text="`${item.quantity}x ${item.name}`"></span>
                            <span x-text="formatPrice(item.price * item.quantity)"></span>
                        </div>
                    </template>
                </div>
            </div>

            <!-- üè∑Ô∏è Quick Discount (Pam's Rounding) -->
            <div class="mb-6">
                <h2 class="text-xl font-semibold text-gray-900 mb-4">üè∑Ô∏è Discount</h2>
                <div class="grid grid-cols-5 gap-2">
                    <button @click="applyDiscount(0)" :class="discount === 0 ? 'bg-gray-300' : 'bg-gray-100'" class="btn-secondary py-3">None</button>
                    <button @click="applyDiscount(5)" :class="discount === 5 ? 'bg-green-300' : 'bg-green-100'" class="btn-secondary py-3">5%</button>
                    <button @click="applyDiscount(10)" :class="discount === 10 ? 'bg-green-300' : 'bg-green-100'" class="btn-secondary py-3">10%</button>
                    <button @click="applyDiscount(15)" :class="discount === 15 ? 'bg-yellow-300' : 'bg-yellow-100'" class="btn-secondary py-3">15%</button>
                    <button @click="customDiscount()" class="btn-secondary py-3 bg-blue-100">Custom</button>
                </div>
                <p class="text-sm text-gray-500 mt-2">üí° Cashiers: max 10% | Managers: max 25% | Admin: unlimited</p>
            </div>

            <!-- Price Breakdown -->
            <div class="bg-indigo-50 rounded-lg p-6 mb-6 space-y-3">
                <div class="flex justify-between">
                    <span>Subtotal:</span>
                    <span x-text="formatPrice(cartData.totals.subtotal)"></span>
                </div>
                <div x-show="discount > 0" class="flex justify-between text-green-600">
                    <span>Discount (<span x-text="discount"></span>%):</span>
                    <span x-text="'-' + formatPrice(discountAmount)"></span>
                </div>
                <div class="flex justify-between">
                    <span>VAT (7.7%):</span>
                    <span x-text="formatPrice(cartData.totals.vat)"></span>
                </div>
                <div class="border-t pt-3 flex justify-between text-xl font-bold">
                    <span>TOTAL:</span>
                    <span class="text-indigo-600" x-text="formatPrice(cartData.totals.total)"></span>
                </div>
            </div>

            <!-- Payment Method -->
            <div class="mb-6">
                <h2 class="text-xl font-semibold text-gray-900 mb-4">üí∞ Payment Method</h2>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <button
                        @click="paymentMethod = 'cash'"
                        :class="paymentMethod === 'cash' ? 'border-4 border-green-500' : 'border-2 border-gray-300'"
                        class="card py-6 text-center cursor-pointer hover:shadow-lg transition">
                        <span class="text-4xl mb-2 block">üíµ</span>
                        <p class="font-semibold">Cash</p>
                    </button>
                    <button
                        @click="paymentMethod = 'visa'"
                        :class="paymentMethod === 'visa' ? 'border-4 border-green-500' : 'border-2 border-gray-300'"
                        class="card py-6 text-center cursor-pointer hover:shadow-lg transition">
                        <span class="text-4xl mb-2 block">üí≥</span>
                        <p class="font-semibold">Visa/MC</p>
                    </button>
                    <button
                        @click="paymentMethod = 'debit'"
                        :class="paymentMethod === 'debit' ? 'border-4 border-green-500' : 'border-2 border-gray-300'"
                        class="card py-6 text-center cursor-pointer hover:shadow-lg transition">
                        <span class="text-4xl mb-2 block">üè¶</span>
                        <p class="font-semibold">Debit</p>
                    </button>
                    <button
                        @click="paymentMethod = 'twint'"
                        :class="paymentMethod === 'twint' ? 'border-4 border-green-500' : 'border-2 border-gray-300'"
                        class="card py-6 text-center cursor-pointer hover:shadow-lg transition">
                        <span class="text-4xl mb-2 block">üì±</span>
                        <p class="font-semibold">TWINT</p>
                    </button>
                </div>
            </div>

            <!-- Dry Run Preview -->
            <div class="bg-yellow-50 border-2 border-yellow-400 rounded-lg p-6 mb-6">
                <h2 class="text-lg font-semibold text-yellow-800 mb-3">‚ö†Ô∏è Dry Run Preview</h2>
                <div class="space-y-2 text-sm text-yellow-900">
                    <p>‚Ä¢ Cash drawer: <span x-text="paymentMethod === 'cash' ? '+' + formatPrice(cartData.totals.total) : 'CHF 0.00 (electronic)'"></span></p>
                    <p>‚Ä¢ Inventory: <span x-text="inventoryPreview()"></span></p>
                    <p>‚Ä¢ Receipt: Will print to POS printer</p>
                    <p>‚Ä¢ Daily total: +<span x-text="formatPrice(cartData.totals.total)"></span></p>
                </div>
            </div>

            <!-- Confirmation -->
            <div class="mb-6 text-center">
                <p class="text-lg text-gray-700">‚ùì Does everything look correct?</p>
            </div>

            <!-- Action Buttons -->
            <div class="grid grid-cols-3 gap-4">
                <button @click="goBack()" class="btn-secondary">
                    ‚ùå Cancel
                </button>
                <button @click="goBack()" class="btn-secondary">
                    ‚úèÔ∏è Edit Cart
                </button>
                <button @click="completeTransaction()" :disabled="processing" class="btn-success">
                    <span x-show="!processing">‚úÖ Confirm & Complete</span>
                    <span x-show="processing">Processing...</span>
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    function checkoutData() {
        return {
            cartData: {cart: [], totals: {}, discount: 0, transactionId: ''},
            paymentMethod: 'visa',
            processing: false,
            discount: 0,
            discountAmount: 0,

            init() {
                const stored = sessionStorage.getItem('pos_cart');
                if (!stored) {
                    showToast('No cart data found', 'warning');
                    setTimeout(() => window.location.href = '/pos/scan', 1000);
                    return;
                }

                this.cartData = JSON.parse(stored);
                this.discount = this.cartData.discount || 0;
                this.recalculateTotals();
            },

            applyDiscount(percent) {
                // TODO: Check user role for max discount
                this.discount = percent;
                this.cartData.discount = percent;
                this.recalculateTotals();
                sessionStorage.setItem('pos_cart', JSON.stringify(this.cartData));
                showToast(`${percent}% discount applied`, 'success');
            },

            customDiscount() {
                const custom = prompt('Enter discount percentage (0-25):');
                if (custom !== null) {
                    const percent = Math.min(25, Math.max(0, parseInt(custom) || 0));
                    this.applyDiscount(percent);
                }
            },

            recalculateTotals() {
                const subtotal = this.cartData.totals.subtotal || 0;
                this.discountAmount = subtotal * (this.discount / 100);
                const afterDiscount = subtotal - this.discountAmount;
                // VAT calculated AFTER discount (Swiss compliant)
                const vat = afterDiscount * 0.077;
                this.cartData.totals.discountAmount = this.discountAmount;
                this.cartData.totals.vat = vat;
                this.cartData.totals.total = afterDiscount + vat;
            },

            inventoryPreview() {
                const counts = {};
                this.cartData.cart.forEach(item => {
                    if (!item.isCatalogItem) {
                        counts[item.name] = (counts[item.name] || 0) + item.quantity;
                    }
                });
                return Object.entries(counts).map(([name, qty]) => `-${qty} ${name}`).join(', ') || 'No inventory changes';
            },

            async completeTransaction() {
                if (!this.paymentMethod) {
                    showToast('Please select a payment method', 'warning');
                    return;
                }

                if (!confirm(`Complete transaction for ${formatPrice(this.cartData.totals.total)}?`)) {
                    return;
                }

                this.processing = true;

                try {
                    // Create transaction
                    const transaction = await API.post('/api/v1/pos/transactions', {});

                    // Add line items
                    for (const item of this.cartData.cart) {
                        await API.post(`/api/v1/pos/transactions/${transaction.id}/items`, {
                            product_id: item.id.toString().startsWith('catalog') ? null : item.id,
                            quantity: item.quantity,
                            unit_price: item.price.toString(),
                            discount_percent: this.cartData.discount.toString()
                        });
                    }

                    // Checkout - cash payments need amount_tendered
                    const checkoutData = {
                        payment_method: this.paymentMethod
                    };
                    if (this.paymentMethod === 'cash') {
                        // For cash, prompt for amount tendered or assume exact amount
                        const amountTendered = prompt(`Amount tendered (Total: CHF ${this.cartData.totals.total.toFixed(2)}):`);
                        if (amountTendered === null) {
                            this.processing = false;
                            return; // User cancelled
                        }
                        checkoutData.amount_tendered = amountTendered || this.cartData.totals.total.toFixed(2);
                    }
                    await API.post(`/api/v1/pos/transactions/${transaction.id}/checkout`, checkoutData);

                    // Clear cart
                    sessionStorage.removeItem('pos_cart');

                    showToast('Transaction completed! Displaying receipt...', 'success');

                    // Redirect to receipt page
                    setTimeout(() => {
                        window.location.href = `/pos/receipt/${transaction.id}`;
                    }, 500);

                } catch (error) {
                    showToast('Error: ' + error.message, 'error');
                    this.processing = false;
                }
            },

            goBack() {
                window.location.href = '/pos/scan';
            },

            formatPrice(amount) {
                return formatPrice(amount);
            }
        }
    }
</script>
{% endblock %}
