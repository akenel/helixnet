{% extends "pos/base.html" %}

{% block title %}Cash Count - HelixPOS{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50" x-data="cashCountData()">
    <div class="max-w-2xl mx-auto px-4 py-8">
        <div class="card">
            <h1 class="text-3xl font-bold text-gray-900 mb-2">üí∞ Cash Drawer Count</h1>
            <p class="text-gray-600 mb-6">End of day cash reconciliation</p>

            <!-- Cashier & Date -->
            <div class="grid grid-cols-2 gap-4 mb-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Cashier</label>
                    <input type="text" x-model="cashierName"
                           class="w-full px-3 py-2 border rounded-lg"
                           placeholder="Pam">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Date</label>
                    <input type="date" x-model="countDate"
                           class="w-full px-3 py-2 border rounded-lg">
                </div>
            </div>

            <!-- Swiss Franc Denominations -->
            <h2 class="text-xl font-semibold text-gray-900 mb-4">üìù Count by Denomination</h2>

            <!-- Notes -->
            <div class="mb-6">
                <h3 class="text-md font-medium text-gray-700 mb-2">Notes (Banknotes)</h3>
                <div class="grid grid-cols-4 gap-3">
                    <template x-for="denom in notes" :key="denom.value">
                        <div class="bg-green-50 rounded-lg p-3 text-center">
                            <div class="text-lg font-bold text-green-800" x-text="'CHF ' + denom.value"></div>
                            <input type="number" min="0" x-model.number="denom.count"
                                   @input="calculateTotal()"
                                   class="w-full mt-2 px-2 py-1 text-center border rounded text-lg font-mono">
                            <div class="text-sm text-green-600 mt-1" x-text="'= ' + formatPrice(denom.value * denom.count)"></div>
                        </div>
                    </template>
                </div>
            </div>

            <!-- Coins -->
            <div class="mb-6">
                <h3 class="text-md font-medium text-gray-700 mb-2">Coins</h3>
                <div class="grid grid-cols-4 gap-3">
                    <template x-for="denom in coins" :key="denom.value">
                        <div class="bg-yellow-50 rounded-lg p-3 text-center">
                            <div class="text-lg font-bold text-yellow-800" x-text="denom.label"></div>
                            <input type="number" min="0" x-model.number="denom.count"
                                   @input="calculateTotal()"
                                   class="w-full mt-2 px-2 py-1 text-center border rounded text-lg font-mono">
                            <div class="text-sm text-yellow-600 mt-1" x-text="'= ' + formatPrice(denom.value * denom.count)"></div>
                        </div>
                    </template>
                </div>
            </div>

            <!-- Totals -->
            <div class="bg-indigo-50 rounded-lg p-6 mb-6">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Expected (from POS)</label>
                        <input type="number" step="0.01" x-model.number="expectedTotal"
                               @input="calculateVariance()"
                               class="w-full px-3 py-2 border rounded-lg text-lg font-mono">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Counted Total</label>
                        <div class="w-full px-3 py-2 bg-white border rounded-lg text-lg font-mono font-bold text-indigo-600"
                             x-text="formatPrice(countedTotal)"></div>
                    </div>
                </div>

                <!-- Variance -->
                <div class="mt-4 pt-4 border-t">
                    <div class="flex justify-between items-center">
                        <span class="text-lg font-medium">Variance:</span>
                        <span class="text-2xl font-bold"
                              :class="variance === 0 ? 'text-green-600' : (variance > 0 ? 'text-blue-600' : 'text-red-600')"
                              x-text="(variance >= 0 ? '+' : '') + formatPrice(variance)"></span>
                    </div>
                    <div class="mt-2 text-sm" :class="variance === 0 ? 'text-green-600' : 'text-gray-500'">
                        <span x-show="variance === 0">‚úÖ Perfect balance! Pam's bonus pool +1 point</span>
                        <span x-show="variance > 0 && variance <= 0.5">‚ú® Over by small amount - goes to cashier bonus</span>
                        <span x-show="variance > 0.5">üìù Over by CHF <span x-text="variance.toFixed(2)"></span> - review recommended</span>
                        <span x-show="variance < 0 && variance >= -0.5">‚ö†Ô∏è Under by small amount - goes to slush fund</span>
                        <span x-show="variance < -0.5">üö® Under by CHF <span x-text="Math.abs(variance).toFixed(2)"></span> - manager review required</span>
                    </div>
                </div>
            </div>

            <!-- Variance Routing -->
            <div x-show="variance !== 0" class="mb-6">
                <h3 class="text-md font-medium text-gray-700 mb-2">Variance Routing</h3>
                <div class="grid grid-cols-3 gap-2">
                    <button @click="varianceRoute = 'bonus'"
                            :class="varianceRoute === 'bonus' ? 'bg-green-500 text-white' : 'bg-green-100'"
                            class="py-2 px-3 rounded-lg text-sm">
                        üéÅ Cashier Bonus
                    </button>
                    <button @click="varianceRoute = 'slush'"
                            :class="varianceRoute === 'slush' ? 'bg-yellow-500 text-white' : 'bg-yellow-100'"
                            class="py-2 px-3 rounded-lg text-sm">
                        üè¶ Slush Fund
                    </button>
                    <button @click="varianceRoute = 'review'"
                            :class="varianceRoute === 'review' ? 'bg-red-500 text-white' : 'bg-red-100'"
                            class="py-2 px-3 rounded-lg text-sm">
                        üëÄ Manager Review
                    </button>
                </div>
            </div>

            <!-- Notes -->
            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-1">Notes (optional)</label>
                <textarea x-model="notes" rows="2"
                          class="w-full px-3 py-2 border rounded-lg"
                          placeholder="Any observations about today's count..."></textarea>
            </div>

            <!-- Action Buttons -->
            <div class="grid grid-cols-2 gap-4">
                <button @click="clearCount()" class="btn-secondary py-3">
                    üîÑ Clear & Restart
                </button>
                <button @click="submitCount()" class="btn-success py-3"
                        :disabled="!cashierName || countedTotal === 0">
                    ‚úÖ Submit Count
                </button>
            </div>

            <!-- Summary (after submit) -->
            <div x-show="submitted" x-transition class="mt-6 bg-green-50 border border-green-200 rounded-lg p-4">
                <h3 class="text-lg font-bold text-green-800 mb-2">‚úÖ Cash Count Submitted</h3>
                <div class="text-sm text-green-700 space-y-1">
                    <p>Cashier: <span x-text="cashierName"></span></p>
                    <p>Date: <span x-text="countDate"></span></p>
                    <p>Counted: <span x-text="formatPrice(countedTotal)"></span></p>
                    <p>Variance: <span x-text="formatPrice(variance)"></span> ‚Üí <span x-text="varianceRoute"></span></p>
                </div>
                <button @click="printSummary()" class="mt-3 btn-secondary py-2 text-sm">
                    üñ®Ô∏è Print Summary
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    function cashCountData() {
        return {
            cashierName: '',
            countDate: new Date().toISOString().split('T')[0],

            // Swiss Franc notes
            notes: [
                { value: 200, count: 0 },
                { value: 100, count: 0 },
                { value: 50, count: 0 },
                { value: 20, count: 0 },
                { value: 10, count: 0 }
            ],

            // Swiss Franc coins
            coins: [
                { value: 5, label: '5 CHF', count: 0 },
                { value: 2, label: '2 CHF', count: 0 },
                { value: 1, label: '1 CHF', count: 0 },
                { value: 0.5, label: '50 Rp', count: 0 },
                { value: 0.2, label: '20 Rp', count: 0 },
                { value: 0.1, label: '10 Rp', count: 0 },
                { value: 0.05, label: '5 Rp', count: 0 }
            ],

            expectedTotal: 0,
            countedTotal: 0,
            variance: 0,
            varianceRoute: 'slush',
            notes: '',
            submitted: false,

            init() {
                // Try to get expected total from today's transactions
                this.loadExpectedTotal();
            },

            async loadExpectedTotal() {
                try {
                    // TODO: API call to get today's cash total
                    // For now, leave it for manual entry
                } catch (e) {
                    console.log('Could not load expected total');
                }
            },

            calculateTotal() {
                let total = 0;
                this.notes.forEach(n => total += n.value * n.count);
                this.coins.forEach(c => total += c.value * c.count);
                this.countedTotal = Math.round(total * 100) / 100;
                this.calculateVariance();
            },

            calculateVariance() {
                this.variance = Math.round((this.countedTotal - this.expectedTotal) * 100) / 100;

                // Auto-select variance route based on amount
                if (this.variance === 0) {
                    this.varianceRoute = 'bonus';
                } else if (Math.abs(this.variance) <= 0.5) {
                    this.varianceRoute = this.variance > 0 ? 'bonus' : 'slush';
                } else {
                    this.varianceRoute = 'review';
                }
            },

            clearCount() {
                this.notes.forEach(n => n.count = 0);
                this.coins.forEach(c => c.count = 0);
                this.countedTotal = 0;
                this.variance = 0;
                this.submitted = false;
            },

            async submitCount() {
                if (!this.cashierName) {
                    showToast('Please enter cashier name', 'warning');
                    return;
                }

                const countData = {
                    cashier: this.cashierName,
                    date: this.countDate,
                    notes_200: this.notes[0].count,
                    notes_100: this.notes[1].count,
                    notes_50: this.notes[2].count,
                    notes_20: this.notes[3].count,
                    notes_10: this.notes[4].count,
                    coins_5: this.coins[0].count,
                    coins_2: this.coins[1].count,
                    coins_1: this.coins[2].count,
                    coins_050: this.coins[3].count,
                    coins_020: this.coins[4].count,
                    coins_010: this.coins[5].count,
                    coins_005: this.coins[6].count,
                    counted_total: this.countedTotal,
                    expected_total: this.expectedTotal,
                    variance: this.variance,
                    variance_route: this.varianceRoute,
                    notes: this.notes
                };

                // TODO: POST to API
                console.log('Cash count submitted:', countData);

                this.submitted = true;
                showToast('Cash count submitted successfully!', 'success');
            },

            printSummary() {
                window.print();
            },

            formatPrice(amount) {
                return 'CHF ' + (amount || 0).toFixed(2);
            }
        }
    }
</script>
{% endblock %}
