{% extends "pos/base.html" %}

{% block title %}KB Approvals - HelixPOS{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50" x-data="kbApprovalData()">
    <div class="max-w-6xl mx-auto px-4 py-8">
        <div class="card">
            <div class="flex justify-between items-center mb-6">
                <div>
                    <h1 class="text-3xl font-bold text-gray-900">üìö KB Approvals</h1>
                    <p class="text-gray-600">Review and approve CRACK knowledge contributions</p>
                </div>
                <div class="flex gap-2">
                    <button @click="selectAll()"
                            class="btn-secondary px-4 py-2"
                            :disabled="pendingKBs.length === 0">
                        ‚òëÔ∏è Select All
                    </button>
                    <button @click="approveSelected()"
                            class="btn-success px-4 py-2"
                            :disabled="selectedKBs.length === 0">
                        ‚úÖ Approve (<span x-text="selectedKBs.length"></span>)
                    </button>
                </div>
            </div>

            <!-- Stats -->
            <div class="grid grid-cols-4 gap-4 mb-6">
                <div class="bg-yellow-50 rounded-lg p-4 text-center">
                    <div class="text-3xl font-bold text-yellow-600" x-text="pendingKBs.length"></div>
                    <div class="text-sm text-yellow-700">Pending Review</div>
                </div>
                <div class="bg-blue-50 rounded-lg p-4 text-center">
                    <div class="text-3xl font-bold text-blue-600" x-text="inReviewKBs.length"></div>
                    <div class="text-sm text-blue-700">In Review</div>
                </div>
                <div class="bg-green-50 rounded-lg p-4 text-center">
                    <div class="text-3xl font-bold text-green-600" x-text="approvedToday"></div>
                    <div class="text-sm text-green-700">Approved Today</div>
                </div>
                <div class="bg-purple-50 rounded-lg p-4 text-center">
                    <div class="text-3xl font-bold text-purple-600" x-text="totalCreditsAwarded"></div>
                    <div class="text-sm text-purple-700">Credits Awarded</div>
                </div>
            </div>

            <!-- Filter Tabs -->
            <div class="flex gap-2 mb-6 border-b">
                <button @click="filter = 'pending'"
                        :class="filter === 'pending' ? 'border-b-2 border-indigo-500 text-indigo-600' : 'text-gray-500'"
                        class="px-4 py-2 font-medium">
                    üì• Pending (<span x-text="pendingKBs.length"></span>)
                </button>
                <button @click="filter = 'in_review'"
                        :class="filter === 'in_review' ? 'border-b-2 border-indigo-500 text-indigo-600' : 'text-gray-500'"
                        class="px-4 py-2 font-medium">
                    üëÄ In Review (<span x-text="inReviewKBs.length"></span>)
                </button>
                <button @click="filter = 'approved'"
                        :class="filter === 'approved' ? 'border-b-2 border-indigo-500 text-indigo-600' : 'text-gray-500'"
                        class="px-4 py-2 font-medium">
                    ‚úÖ Recently Approved
                </button>
            </div>

            <!-- KB List -->
            <div class="space-y-4">
                <template x-for="kb in filteredKBs" :key="kb.id">
                    <div class="border-2 rounded-lg p-4 transition"
                         :class="selectedKBs.includes(kb.id) ? 'border-green-500 bg-green-50' : 'border-gray-200 hover:border-indigo-300'">

                        <!-- Header -->
                        <div class="flex items-start gap-4">
                            <!-- Checkbox -->
                            <input type="checkbox"
                                   :checked="selectedKBs.includes(kb.id)"
                                   @change="toggleSelect(kb.id)"
                                   class="mt-1 w-5 h-5 rounded">

                            <!-- Content -->
                            <div class="flex-1">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <h3 class="text-lg font-semibold text-gray-900" x-text="kb.title"></h3>
                                        <p class="text-sm text-gray-500">
                                            by <span class="font-medium" x-text="kb.author_handle"></span>
                                            <span x-text="crackEmoji(kb.author_crack_level)"></span>
                                            ‚Ä¢ <span x-text="kb.category"></span>
                                            ‚Ä¢ <span x-text="formatDate(kb.submitted_at)"></span>
                                        </p>
                                    </div>
                                    <div class="text-right">
                                        <span class="inline-block px-2 py-1 rounded text-xs font-medium"
                                              :class="statusClass(kb.status)"
                                              x-text="kb.status"></span>
                                    </div>
                                </div>

                                <!-- Summary -->
                                <p class="mt-2 text-gray-600" x-text="kb.summary"></p>

                                <!-- Quality Badges -->
                                <div class="flex gap-2 mt-3">
                                    <span x-show="kb.has_images" class="px-2 py-1 bg-blue-100 text-blue-700 rounded text-xs">üì∑ Images</span>
                                    <span x-show="kb.has_video" class="px-2 py-1 bg-purple-100 text-purple-700 rounded text-xs">üé¨ Video</span>
                                    <span x-show="kb.has_bom" class="px-2 py-1 bg-green-100 text-green-700 rounded text-xs">üìã BOM/Recipe</span>
                                    <span x-show="kb.has_lab_report" class="px-2 py-1 bg-yellow-100 text-yellow-700 rounded text-xs">üî¨ Lab Report</span>
                                    <span x-show="kb.jh_reference" class="px-2 py-1 bg-orange-100 text-orange-700 rounded text-xs" x-text="'üìñ ' + kb.jh_reference"></span>
                                </div>

                                <!-- Credits Preview -->
                                <div class="mt-3 flex items-center gap-4 text-sm">
                                    <span class="text-gray-500">Credits if approved:</span>
                                    <span class="font-bold text-green-600" x-text="kb.potential_credits + ' credits'"></span>
                                    <span class="text-gray-400" x-text="'(base: 100 + bonuses: ' + (kb.potential_credits - 100) + ')'"></span>
                                </div>

                                <!-- Review Summary -->
                                <div x-show="kb.reviews && kb.reviews.length > 0" class="mt-3 p-3 bg-gray-50 rounded">
                                    <div class="text-sm font-medium text-gray-700 mb-2">CRACK Reviews:</div>
                                    <div class="flex gap-4">
                                        <span class="text-green-600">üëç <span x-text="kb.reviews.filter(r => r.recommend).length"></span> recommend</span>
                                        <span class="text-red-600">üëé <span x-text="kb.reviews.filter(r => !r.recommend).length"></span> concerns</span>
                                        <span class="text-yellow-600">‚≠ê <span x-text="kb.average_rating.toFixed(1)"></span>/5 avg</span>
                                    </div>
                                </div>

                                <!-- Actions -->
                                <div class="mt-4 flex gap-2">
                                    <button @click="previewKB(kb)" class="btn-secondary text-sm px-3 py-1">
                                        üëÅÔ∏è Preview
                                    </button>
                                    <button @click="sendForReview(kb)" x-show="kb.status === 'submitted'" class="btn-secondary text-sm px-3 py-1">
                                        üì§ Send to CRACKs
                                    </button>
                                    <button @click="approveOne(kb)" class="btn-success text-sm px-3 py-1">
                                        ‚úÖ Approve
                                    </button>
                                    <button @click="rejectKB(kb)" class="text-sm px-3 py-1 text-red-600 hover:bg-red-50 rounded">
                                        ‚ùå Reject
                                    </button>
                                    <button @click="featureKB(kb)" x-show="kb.status === 'approved'" class="text-sm px-3 py-1 text-yellow-600 hover:bg-yellow-50 rounded">
                                        ‚≠ê Feature
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </template>

                <!-- Empty State -->
                <div x-show="filteredKBs.length === 0" class="text-center py-12 text-gray-500">
                    <div class="text-6xl mb-4">üì≠</div>
                    <p>No KBs in this category</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Preview Modal -->
    <div x-show="previewingKB" x-transition class="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg max-w-4xl w-full max-h-[90vh] overflow-auto m-4">
            <div class="p-6">
                <div class="flex justify-between items-start mb-4">
                    <h2 class="text-2xl font-bold" x-text="previewingKB?.title"></h2>
                    <button @click="previewingKB = null" class="text-gray-500 hover:text-gray-700">‚úï</button>
                </div>
                <div class="prose max-w-none" x-html="previewingKB?.content || 'Loading...'"></div>
                <div class="mt-6 flex gap-2 justify-end">
                    <button @click="previewingKB = null" class="btn-secondary">Close</button>
                    <button @click="approveOne(previewingKB); previewingKB = null" class="btn-success">‚úÖ Approve</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    function kbApprovalData() {
        return {
            filter: 'pending',
            selectedKBs: [],
            previewingKB: null,
            approvedToday: 5,
            totalCreditsAwarded: 1250,

            pendingKBs: [],
            inReviewKBs: [],
            approvedKBs: [],

            async init() {
                await this.loadKBs();
            },

            async loadKBs() {
                try {
                    const token = sessionStorage.getItem('access_token');
                    if (!token) {
                        showToast('Please log in', 'warning');
                        return;
                    }

                    // Load all pending KBs
                    const response = await fetch('/api/v1/kb/pending?status_filter=all', {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });

                    if (!response.ok) {
                        if (response.status === 403) {
                            showToast('Manager access required', 'warning');
                            return;
                        }
                        throw new Error('Failed to load KBs');
                    }

                    const kbs = await response.json();
                    this.pendingKBs = kbs.map(kb => ({
                        ...kb,
                        reviews: [],
                        average_rating: kb.rating_average || 0
                    }));

                } catch (error) {
                    console.error('Load KBs error:', error);
                    showToast('Failed to load KBs', 'error');
                }
            },

            get filteredKBs() {
                if (this.filter === 'pending') return this.pendingKBs.filter(kb => kb.status === 'submitted');
                if (this.filter === 'in_review') return this.pendingKBs.filter(kb => kb.status === 'in_review');
                if (this.filter === 'approved') return this.approvedKBs;
                return [];
            },

            selectAll() {
                if (this.selectedKBs.length === this.filteredKBs.length) {
                    this.selectedKBs = [];
                } else {
                    this.selectedKBs = this.filteredKBs.map(kb => kb.id);
                }
            },

            toggleSelect(id) {
                if (this.selectedKBs.includes(id)) {
                    this.selectedKBs = this.selectedKBs.filter(x => x !== id);
                } else {
                    this.selectedKBs.push(id);
                }
            },

            async approveSelected() {
                const count = this.selectedKBs.length;
                if (!confirm(`Approve ${count} KB(s)? Credits will be awarded to authors.`)) return;

                try {
                    const token = sessionStorage.getItem('access_token');
                    const response = await fetch('/api/v1/kb/approve-batch', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(this.selectedKBs)
                    });

                    if (response.ok) {
                        const result = await response.json();
                        showToast(result.message, 'success');

                        // Move to approved
                        this.pendingKBs = this.pendingKBs.filter(kb => !this.selectedKBs.includes(kb.id));
                        this.approvedToday += result.approved_count;
                        this.totalCreditsAwarded += result.total_credits_awarded;
                        this.selectedKBs = [];
                    } else {
                        throw new Error('Batch approve failed');
                    }
                } catch (error) {
                    showToast('Failed to approve: ' + error.message, 'error');
                }
            },

            async approveOne(kb) {
                try {
                    const token = sessionStorage.getItem('access_token');
                    const response = await fetch(`/api/v1/kb/${kb.id}/approve`, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });

                    if (response.ok) {
                        const result = await response.json();
                        showToast(result.message, 'success');
                        this.pendingKBs = this.pendingKBs.filter(k => k.id !== kb.id);
                        this.approvedToday++;
                        this.totalCreditsAwarded += result.credits_awarded;
                    } else {
                        throw new Error('Approve failed');
                    }
                } catch (error) {
                    showToast('Failed to approve: ' + error.message, 'error');
                }
            },

            async sendForReview(kb) {
                try {
                    const token = sessionStorage.getItem('access_token');
                    const response = await fetch(`/api/v1/kb/${kb.id}/send-for-review`, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });

                    if (response.ok) {
                        kb.status = 'in_review';
                        showToast('Sent to CRACKs for review', 'info');
                    }
                } catch (error) {
                    showToast('Failed: ' + error.message, 'error');
                }
            },

            async rejectKB(kb) {
                const reason = prompt('Reason for rejection (will be sent to author):');
                if (reason && reason.length >= 10) {
                    try {
                        const token = sessionStorage.getItem('access_token');
                        const response = await fetch(`/api/v1/kb/${kb.id}/reject?reason=${encodeURIComponent(reason)}`, {
                            method: 'POST',
                            headers: { 'Authorization': `Bearer ${token}` }
                        });

                        if (response.ok) {
                            showToast(`Rejected with feedback sent to ${kb.author_handle}`, 'warning');
                            this.pendingKBs = this.pendingKBs.filter(k => k.id !== kb.id);
                        }
                    } catch (error) {
                        showToast('Failed: ' + error.message, 'error');
                    }
                } else if (reason) {
                    showToast('Please provide at least 10 characters of feedback', 'warning');
                }
            },

            async featureKB(kb) {
                showToast(`"${kb.title}" is now featured! +250 bonus credits to ${kb.author_handle}`, 'success');
            },

            previewKB(kb) {
                this.previewingKB = kb;
                // TODO: Load full content
                this.previewingKB.content = `<h2>${kb.title}</h2><p>${kb.summary}</p><p><em>Full content would load here from the markdown file...</em></p>`;
            },

            formatDate(dateStr) {
                const date = new Date(dateStr);
                return date.toLocaleDateString('de-CH', { day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit' });
            },

            statusClass(status) {
                const classes = {
                    'submitted': 'bg-yellow-100 text-yellow-700',
                    'in_review': 'bg-blue-100 text-blue-700',
                    'approved': 'bg-green-100 text-green-700',
                    'published': 'bg-purple-100 text-purple-700',
                    'rejected': 'bg-red-100 text-red-700'
                };
                return classes[status] || '';
            },

            crackEmoji(level) {
                const emojis = {
                    'seedling': 'üå±',
                    'sprout': 'üåø',
                    'rooted': 'ü™¥',
                    'growing': 'üå≥',
                    'blazing': 'üí®',
                    'oracle': 'üëë'
                };
                return emojis[level] || 'üå±';
            }
        }
    }
</script>
{% endblock %}
