{% extends "pos/base.html" %}

{% block title %}Transaction History - HelixPOS{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50" x-data="transactionsData()">
    <!-- Header -->
    <nav class="bg-white shadow-lg sticky top-0 z-10">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <button @click="goBack()" class="btn-secondary">
                    ‚Üê Back to Dashboard
                </button>
                <h1 class="text-2xl font-bold text-gray-900">üí≥ Transaction History</h1>
                <div class="text-sm text-gray-600">
                    <span x-text="user.username"></span> | <span x-text="roleDisplay()"></span>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Filter Bar -->
        <div class="card mb-6">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div>
                    <label class="text-sm font-semibold text-gray-700">Date:</label>
                    <input type="date" x-model="filterDate" @change="loadTransactions()" class="input-field">
                </div>
                <div>
                    <label class="text-sm font-semibold text-gray-700">Status:</label>
                    <select x-model="filterStatus" @change="loadTransactions()" class="input-field">
                        <option value="">All</option>
                        <option value="completed">Completed</option>
                        <option value="open">Open</option>
                        <option value="voided">Voided</option>
                    </select>
                </div>
                <div>
                    <label class="text-sm font-semibold text-gray-700">Payment Method:</label>
                    <select x-model="filterPayment" @change="loadTransactions()" class="input-field">
                        <option value="">All</option>
                        <option value="cash">Cash</option>
                        <option value="card">Card</option>
                        <option value="mobile">Mobile</option>
                    </select>
                </div>
                <div class="flex items-end">
                    <button @click="resetFilters()" class="btn-secondary w-full">
                        Reset Filters
                    </button>
                </div>
            </div>
        </div>

        <!-- Summary Stats -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
            <div class="card">
                <p class="text-sm text-gray-600">Total Transactions</p>
                <p class="text-3xl font-bold text-gray-900" x-text="summary.count"></p>
            </div>
            <div class="card">
                <p class="text-sm text-gray-600">Total Sales</p>
                <p class="text-3xl font-bold text-green-600" x-text="formatPrice(summary.total)"></p>
            </div>
            <div class="card">
                <p class="text-sm text-gray-600">Cash Sales</p>
                <p class="text-2xl font-bold text-gray-900" x-text="formatPrice(summary.cash)"></p>
            </div>
            <div class="card">
                <p class="text-sm text-gray-600">Card/Mobile Sales</p>
                <p class="text-2xl font-bold text-gray-900" x-text="formatPrice(summary.card)"></p>
            </div>
        </div>

        <!-- Loading State -->
        <div x-show="loading" class="text-center py-12">
            <div class="animate-spin inline-block w-12 h-12 border-4 border-indigo-600 border-t-transparent rounded-full"></div>
            <p class="mt-4 text-gray-600">Loading transactions...</p>
        </div>

        <!-- Empty State -->
        <div x-show="!loading && transactions.length === 0" class="card text-center py-12">
            <span class="text-6xl mb-4 block">üì≠</span>
            <h3 class="text-xl font-semibold text-gray-900 mb-2">No Transactions Found</h3>
            <p class="text-gray-600">Try adjusting your filters or select a different date.</p>
        </div>

        <!-- Transactions Table -->
        <div x-show="!loading && transactions.length > 0" class="card overflow-hidden">
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-gray-100">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase">Receipt #</th>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase">Date/Time</th>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase">Cashier</th>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase">Payment</th>
                            <th class="px-4 py-3 text-right text-xs font-semibold text-gray-700 uppercase">Total</th>
                            <th class="px-4 py-3 text-center text-xs font-semibold text-gray-700 uppercase">Status</th>
                            <th class="px-4 py-3 text-center text-xs font-semibold text-gray-700 uppercase">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200">
                        <template x-for="txn in transactions" :key="txn.id">
                            <tr class="hover:bg-gray-50 transition cursor-pointer" @click="viewReceipt(txn.id)">
                                <td class="px-4 py-3">
                                    <p class="font-semibold text-gray-900" x-text="txn.receipt_number || txn.transaction_number"></p>
                                    <p class="text-xs text-gray-500" x-text="txn.transaction_number"></p>
                                </td>
                                <td class="px-4 py-3">
                                    <p class="text-sm text-gray-900" x-text="formatDate(txn.completed_at || txn.created_at)"></p>
                                    <p class="text-xs text-gray-500" x-text="formatTime(txn.completed_at || txn.created_at)"></p>
                                </td>
                                <td class="px-4 py-3 text-sm text-gray-900">
                                    <span x-text="txn.cashier_name || 'Cashier'"></span>
                                </td>
                                <td class="px-4 py-3">
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium"
                                          :class="{
                                              'bg-green-100 text-green-800': txn.payment_method === 'cash',
                                              'bg-blue-100 text-blue-800': txn.payment_method === 'card',
                                              'bg-purple-100 text-purple-800': txn.payment_method === 'mobile',
                                              'bg-gray-100 text-gray-800': !txn.payment_method
                                          }"
                                          x-text="(txn.payment_method || 'none').toUpperCase()">
                                    </span>
                                </td>
                                <td class="px-4 py-3 text-right">
                                    <p class="text-lg font-bold text-gray-900" x-text="formatPrice(txn.total)"></p>
                                </td>
                                <td class="px-4 py-3 text-center">
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium"
                                          :class="{
                                              'bg-green-100 text-green-800': txn.status === 'completed',
                                              'bg-yellow-100 text-yellow-800': txn.status === 'open',
                                              'bg-red-100 text-red-800': txn.status === 'voided'
                                          }"
                                          x-text="txn.status.toUpperCase()">
                                    </span>
                                </td>
                                <td class="px-4 py-3 text-center" @click.stop>
                                    <button @click="viewReceipt(txn.id)" class="text-indigo-600 hover:text-indigo-900 font-medium mr-3">
                                        View
                                    </button>
                                    <button @click="reprintReceipt(txn.id)" class="text-green-600 hover:text-green-900 font-medium">
                                        Reprint
                                    </button>
                                </td>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
    function transactionsData() {
        return {
            user: {},
            transactions: [],
            summary: {
                count: 0,
                total: 0,
                cash: 0,
                card: 0
            },
            loading: false,
            filterDate: new Date().toISOString().split('T')[0], // Today
            filterStatus: '',
            filterPayment: '',

            async init() {
                const userInfo = AuthHelper.getUserInfo();
                if (!userInfo) {
                    window.location.href = '/pos';
                    return;
                }
                this.user = userInfo;

                await this.loadTransactions();
            },

            async loadTransactions() {
                this.loading = true;

                try {
                    // Build query parameters
                    const params = new URLSearchParams();
                    if (this.filterDate) params.append('date', this.filterDate);
                    if (this.filterStatus) params.append('status', this.filterStatus);
                    if (this.filterPayment) params.append('payment_method', this.filterPayment);

                    // For now, we'll use the products endpoint as a placeholder
                    // TODO: Create proper transactions list endpoint
                    // const data = await API.get(`/api/v1/pos/transactions?${params}`);

                    // Placeholder: Empty array until we build the backend endpoint
                    this.transactions = [];

                    // Calculate summary
                    this.calculateSummary();

                } catch (error) {
                    console.error('Failed to load transactions:', error);
                    showToast('Failed to load transactions: ' + error.message, 'error');
                } finally {
                    this.loading = false;
                }
            },

            calculateSummary() {
                this.summary.count = this.transactions.length;
                this.summary.total = this.transactions.reduce((sum, t) => sum + parseFloat(t.total || 0), 0);
                this.summary.cash = this.transactions
                    .filter(t => t.payment_method === 'cash')
                    .reduce((sum, t) => sum + parseFloat(t.total || 0), 0);
                this.summary.card = this.transactions
                    .filter(t => ['card', 'mobile'].includes(t.payment_method))
                    .reduce((sum, t) => sum + parseFloat(t.total || 0), 0);
            },

            resetFilters() {
                this.filterDate = new Date().toISOString().split('T')[0];
                this.filterStatus = '';
                this.filterPayment = '';
                this.loadTransactions();
            },

            viewReceipt(transactionId) {
                window.location.href = `/pos/receipt/${transactionId}`;
            },

            reprintReceipt(transactionId) {
                // Open in new tab so user doesn't lose transaction history page
                window.open(`/pos/receipt/${transactionId}`, '_blank');
            },

            formatDate(dateString) {
                if (!dateString) return '';
                const date = new Date(dateString);
                return date.toLocaleDateString('de-CH', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit'
                });
            },

            formatTime(dateString) {
                if (!dateString) return '';
                const date = new Date(dateString);
                return date.toLocaleTimeString('de-CH', {
                    hour: '2-digit',
                    minute: '2-digit'
                });
            },

            formatPrice(amount) {
                return formatPrice(amount);
            },

            roleDisplay() {
                return this.user.posRoles?.join(', ') || 'User';
            },

            goBack() {
                window.location.href = '/pos/dashboard';
            }
        }
    }
</script>
{% endblock %}
