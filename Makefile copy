# ==========================================
# ğŸ§  HelixNet Makefile â€“ Managed with Care ğŸ§ 
# ==========================================
# Purpose: Simplify Docker Compose orchestration & database management
# Author: Sherlock (Your faithful assistant)
# Updated: 2025-10-05
# ==========================================

# ğŸ§© VARIABLES
COMPOSE_FILE := docker-compose.yml
PROJECT_NAME := helixnet

# Profiles
CORE_PROFILES := --profile core
APP_PROFILES := --profile app

# Helpers for colorful output ğŸŒˆ
INFO  = @echo "ğŸŸ¦ [INFO] "
OK    = @echo "ğŸŸ© [OK] "
WARN  = @echo "ğŸŸ¨ [WARN] "
ERR   = @echo "ğŸŸ¥ [ERROR] "


# ==========================================
# ğŸš€ MAIN TARGETS
# ==========================================

.PHONY: start
start: ## ğŸ”¥ Start all core + app services
	$(INFO) "Starting HelixNet stack..."
	docker compose -f $(COMPOSE_FILE) $(CORE_PROFILES) $(APP_PROFILES) up -d
	$(OK) "All services are up and running! ğŸš€"

.PHONY: stop
stop: ## ğŸ§¯ Stop and remove all containers
	$(INFO) "Stopping and cleaning up containers..."
	docker compose -f $(COMPOSE_FILE) down
	$(OK) "Containers stopped and removed. ğŸ§¹"

.PHONY: build
build: ## ğŸ› ï¸ Build all Docker images
	$(INFO) "Building Docker images..."
	docker compose -f $(COMPOSE_FILE) build
	$(OK) "Build complete! âœ…"

.PHONY: rebuild
rebuild: ## ğŸ”„ Stop, rebuild, and start everything fresh
	$(INFO) "Rebuilding full environment..."
	$(MAKE) stop
	$(MAKE) build
	$(MAKE) start
	$(OK) "Full rebuild completed! ğŸ§©"


# ==========================================
# âš™ï¸ CORE SERVICES
# ==========================================

.PHONY: core-up
core-up: ## ğŸ§± Start only core services (DB, cache, broker, storage)
	$(INFO) "Starting core infrastructure..."
	docker compose -f $(COMPOSE_FILE) $(CORE_PROFILES) up -d
	$(OK) "Core services are up. ğŸ’¾"

.PHONY: logs
logs: ## ğŸ“œ Tail logs from all running containers
	$(INFO) "Tailing logs... (Ctrl+C to exit)"
	docker compose -f $(COMPOSE_FILE) logs -f


# ==========================================
# ğŸ—„ï¸ DATABASE & MIGRATIONS
# ==========================================

Makefile
Variables for Docker Compose commands

COMPOSE_FILE := docker-compose.yaml
Define profiles for easy launch control

CORE_SERVICES := postgres redis rabbitmq minio
APP_SERVICES := web worker
Default target for quick start

.PHONY: start
start: ## Launches core infrastructure and the application services.
docker compose -f $(COMPOSE_FILE) --profile core --profile app up -d

.PHONY: core-up
core-up: ## Launches only the core infrastructure (DBs, Cache, Broker)
docker compose -f $(COMPOSE_FILE) --profile core up -d

.PHONY: stop
stop: ## Stops and removes all HelixNet containers and default network.
docker compose -f $(COMPOSE_FILE) down

.PHONY: build
build: ## Builds the application Docker image.
docker compose -f $(COMPOSE_FILE) build

.PHONY: rebuild
rebuild: stop build start ## Stop, rebuild, and start everything fresh

.PHONY: logs
logs: ## Follows the logs for all running services.
docker compose -f $(COMPOSE_FILE) logs -f

.PHONY: links
links: ## Displays essential access links.
@echo "\n--- HelixNet Access Links ---"
@echo "Web App:      http://localhost:8000"
@echo "MinIO Console:  http://localhost:9001 (User/Pass from .env)"
@echo "RabbitMQ Mgmt:  http://localhost:15672 (User/Pass from .env)"
@echo "---------------------------\n"


.PHONY: reset-db
reset-db: ## ğŸ’£ Reset database and reapply migrations
	$(WARN) "âš ï¸  This will nuke your DB and rebuild it!"
	docker compose -f $(COMPOSE_FILE) down -v
	docker compose -f $(COMPOSE_FILE) $(CORE_PROFILES) up -d
	docker compose -f $(COMPOSE_FILE) $(APP_PROFILES) build
	docker compose -f $(COMPOSE_FILE) $(APP_PROFILES) run --rm web alembic upgrade head
	$(OK) "Database reset and migrated. ğŸ§©"


# ==========================================
# ğŸ§° UTILITIES
# ==========================================

.PHONY: show-tables
show-tables: ## ğŸ§¾ Show all SQLAlchemy table names
	$(INFO) "Fetching table names from database..."
	docker compose -f $(COMPOSE_FILE) $(APP_PROFILES) run --rm web \
	python -c "from app.db.database import Base; import app.db.models; print(Base.metadata.tables.keys())"

.PHONY: test
test: ## ğŸ§ª Run pytest inside the web container
	$(INFO) "Running tests..."
	docker compose exec web pytest app/tests/ -v
	$(OK) "All tests completed. ğŸ§ª"

.PHONY: links
links: ## ğŸ”— Show quick access links for local services
	@echo "\nğŸŒ --- HelixNet Access Links ---"
	@echo "ğŸï¸ GitHub Repo:			https://github.com/akenel/helixnet/tree/main#"
	@echo "ğŸ’» WebApp Backend OpenApi:	http://localhost:8000/docs (User marcel@helix.net /Pass marcel from seeded users)"
	@echo "ğŸ‡ Flower UI:			http://0.0.0.0:5555/ (User/Pass)"
	@echo "ğŸ‡ Redis UI:			http://0.0.0.0:5540/ (User/Pass with Accepting Licence Aggrement)"
	@echo "ğŸ“¨ RabbitMQ Mgmt:		http://localhost:15672 (User/Pass from .env)"
	@echo "ğŸ—„ï¸  MinIO Console:		http://0.0.0.0:9091 (User minioadmin /Pass minioadmin from .env)"
	@echo "ğŸ§  PgAdmin UI ğŸ˜ Postgres:	http://0.0.0.0:5050/browser/ (User helix_user /Pass helix_pass for 'helix_db' from .env)"
	@echo "ğŸ§© Portainer Dashboard:		https://localhost:9999 (User Secure admin/Pass from KeePass)"
    
	@echo "-----------------------------------\n"

# ==========================================
# ğŸ’¡ HELP MENU (THE CROWN JEWEL)
# ==========================================

.PHONY: help
help: ## ğŸ•µï¸ Show this help menu
	@echo "ğŸ” \033[1mAvailable Commands for HelixNet:\033[0m\n"
	@grep -E '^[a-zA-Z_-]+:.*##' $(MAKEFILE_LIST) \
		| awk 'BEGIN {FS = ":.*##"}; {printf "âš™ï¸  \033[36m%-20s\033[0m %s\n", $$1, $$2}'
	@echo "\nğŸ’¡ Example: make start   ğŸš€"

.PHONY: migrate
migrate: ## Apply Alembic migrations to latest head
	$(INFO) "Running Alembic migrations..."
	# FIX: Only activate the 'core' profile (which contains postgres) when running the command.
	docker compose -f $(COMPOSE_FILE) $(CORE_PROFILES) run --rm web alembic upgrade head
	$(OK) "Migrations applied successfully! ğŸ‰"

.PHONY: revision
revision: ## ğŸ§± Create a new Alembic migration (usage: make revision msg="message")
	$(INFO) "Creating Alembic revision: $(msg)"
	docker compose -f $(COMPOSE_FILE) $(APP_PROFILES) run --rm web alembic revision --autogenerate -m "$(msg)"
	$(OK) "New revision created. ğŸª¶"