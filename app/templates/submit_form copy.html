<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CN Job Submission Portal (v1.2.2)</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Configure Tailwind to use Inter font and custom colors -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'cn-dark': '#0f172a', // Slate 900
                        'cn-primary': '#1e293b', // Slate 800
                        'cn-secondary': '#475569', // Slate 600
                        'cn-accent': '#22c55e', // Emerald 500
                    }
                }
            }
        }
    </script>
    <style>
        /* Ensuring Inter is loaded (optional if CDN works) */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
    </style>
</head>
<body class="bg-cn-dark min-h-screen flex flex-col items-center p-4 font-sans text-white">

    <div class="w-full max-w-4xl space-y-8">
        <!-- Header -->
        <header class="text-center p-6 bg-cn-primary rounded-xl shadow-2xl border-b-4 border-cn-accent">
            <h1 class="text-3xl sm:text-4xl font-extrabold tracking-tight">
                ðŸ¥‹ Asynchronous Job Dispatch: V1.2.2
            </h1>
            <p class="text-cn-secondary mt-2 text-lg">
                Submit a Chuck Norris-Approved Task for Background Processing.
            </p>
        </header>

        <!-- Authentication Token Input -->
        <div class="bg-cn-primary p-6 rounded-xl shadow-xl">
            <h2 class="text-xl font-bold mb-3 flex items-center">
                <svg class="w-6 h-6 mr-2 text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2v6a2 2 0 01-2 2h-6a2 2 0 01-2-2V9a2 2 0 012-2h6zM13 16h-2"></path></svg>
                Bearer Token (Required)
            </h2>
            <p class="text-sm text-cn-secondary mb-3">
                Enter your valid JWT here, or use the **Get Token** button to retrieve a session placeholder for testing.
            </p>
            <div class="flex space-x-3">
                <input type="text" id="auth-token" placeholder="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
                       class="w-full p-3 bg-cn-dark text-cn-accent border border-cn-secondary rounded-lg focus:outline-none focus:ring-2 focus:ring-cn-accent transition duration-200">
                
                <button type="button" id="get-token-button" onclick="getMockToken()"
                        class="flex-shrink-0 p-3 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition duration-200 shadow-md focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:bg-gray-500">
                    Get Token
                </button>
            </div>
        </div>

        <!-- Job Submission Form -->
        <form id="job-form" class="bg-cn-primary p-6 rounded-xl shadow-xl space-y-6 border border-cn-secondary">
            <h2 class="text-2xl font-bold mb-4 flex items-center">
                <svg class="w-7 h-7 mr-2 text-cn-accent" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                Task Definition
            </h2>

            <div>
                <label for="job-title" class="block text-cn-secondary mb-1 font-semibold">Job Title (e.g., "Monthly Report Generation")</label>
                <input type="text" id="job-title" name="title" required placeholder="CN Data Analysis Task"
                       class="w-full p-3 bg-cn-dark border border-cn-secondary rounded-lg focus:outline-none focus:ring-2 focus:ring-cn-accent"
                       value="Triple Roundhouse Audit Request">
            </div>

            <div>
                <label for="file-upload" class="block text-cn-secondary mb-1 font-semibold">File Input (Future MinIO Target)</label>
                <div class="flex items-center justify-center w-full">
                    <!-- Note: File upload is for visual demonstration. Current API uses JSON payload. -->
                    <label for="file-upload" class="flex flex-col items-center justify-center w-full h-20 border-2 border-dashed border-cn-secondary rounded-lg cursor-pointer bg-cn-dark hover:bg-slate-700 transition duration-200">
                        <div class="flex flex-col items-center justify-center pt-2 pb-3">
                            <svg class="w-8 h-8 mb-2 text-cn-secondary" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 014 4v2m-5 4l-4-4m0 0l-4 4m4-4v12"></path></svg>
                            <p class="text-sm text-cn-secondary"><span class="font-semibold">Click to upload</span> or drag and drop</p>
                        </div>
                        <input id="file-upload" type="file" class="hidden" name="file">
                    </label>
                </div> 
            </div>

            <button type="submit" id="submit-button"
                    class="w-full p-3 mt-4 bg-cn-accent text-cn-dark font-extrabold rounded-lg shadow-lg hover:bg-emerald-600 transition duration-300 transform hover:scale-[1.01] focus:outline-none focus:ring-4 focus:ring-cn-accent/50 disabled:opacity-50 flex items-center justify-center">
                <span id="button-text">DISPATCH JOB NOW ðŸš€</span>
                <span id="loading-spinner" class="hidden animate-spin h-5 w-5 ml-2 border-2 border-cn-dark border-r-transparent rounded-full"></span>
            </button>
        </form>

        <!-- Response Panel -->
        <div id="response-panel" class="hidden bg-cn-primary p-6 rounded-xl shadow-2xl">
            <h2 class="text-2xl font-bold mb-4 text-cn-accent flex items-center">
                <svg class="w-7 h-7 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                Job Dispatch Confirmed (HTTP 201)
            </h2>
            <p class="text-cn-secondary mb-4">
                Your asynchronous task has been successfully enqueued and will be processed by the worker fleet. Use the Job ID below to check its status.
            </p>
            <div id="response-details" class="space-y-3 bg-cn-dark p-4 rounded-lg">
                <!-- Details will be injected here -->
            </div>
            <div id="error-message" class="hidden bg-red-800/30 text-red-400 p-4 mt-4 rounded-lg font-mono">
                <!-- Errors will be injected here -->
            </div>
        </div>

    </div>

    <footer class="mt-8 text-cn-secondary text-sm">
        &copy; 2025 HelixNet Enterprise Solution - V1.2.2 Tag
    </footer>

    <script>
        const API_BASE_URL = "/api/v1";
        const form = document.getElementById('job-form');
        const tokenInput = document.getElementById('auth-token');
        const tokenButton = document.getElementById('get-token-button');
        const responsePanel = document.getElementById('response-panel');
        const responseDetails = document.getElementById('response-details');
        const errorMessage = document.getElementById('error-message');
        const submitButton = document.getElementById('submit-button');
        const buttonText = document.getElementById('button-text');
        const loadingSpinner = document.getElementById('loading-spinner');

        // Function to generate a visually convincing mock JWT
        const generateMockJwt = (email = 'chuck.norris@helixnet.com') => {
            // Header: {"alg":"HS256","typ":"JWT"}
            const header = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9';
            // Payload: {"sub":"user-uuid-123", "email":"...", "exp": (future timestamp)}
            const payload = btoa(JSON.stringify({
                sub: 'cn-user-7d9a8f4b-3c2e-4a1d-8b0f-5e6c7d8a9b0c',
                email: email,
                exp: Math.floor(Date.now() / 1000) + (60 * 60 * 24) // 24 hours from now
            })).replace(/=/g, ''); // Base64url encoding removes padding
            // Mock Signature (just random base64 string)
            const signature = 'G0LDs7m9YtFz5Xp8A_2nJq-WkLhV_RjEwZcTfQ';
            return `${header}.${payload}.${signature}`;
        };

        // Function to simulate token acquisition
        const getMockToken = () => {
            tokenButton.disabled = true;
            tokenButton.textContent = 'Acquiring...';
            tokenButton.classList.remove('bg-blue-600', 'hover:bg-blue-700');
            tokenButton.classList.add('bg-gray-500');

            // Simulate 1.5 second network latency for login/token exchange
            setTimeout(() => {
                const mockToken = generateMockJwt();
                tokenInput.value = mockToken;

                tokenButton.textContent = 'Token Acquired! ðŸ”“';
                tokenButton.classList.remove('bg-gray-500');
                tokenButton.classList.add('bg-cn-accent', 'hover:bg-emerald-600');
                tokenButton.disabled = false;
                
                // Reset the button appearance after a moment
                setTimeout(() => {
                    tokenButton.textContent = 'Get Token';
                    tokenButton.classList.remove('bg-cn-accent', 'hover:bg-emerald-600');
                    tokenButton.classList.add('bg-blue-600', 'hover:bg-blue-700');
                }, 2000);

            }, 1500); 
        };

        // Helper function to show/hide loading state
        const setLoading = (isLoading) => {
            submitButton.disabled = isLoading;
            if (isLoading) {
                buttonText.textContent = 'DISPATCHING...';
                loadingSpinner.classList.remove('hidden');
                submitButton.classList.add('bg-gray-500');
                submitButton.classList.remove('bg-cn-accent', 'hover:bg-emerald-600');
            } else {
                buttonText.textContent = 'DISPATCH JOB NOW ðŸš€';
                loadingSpinner.classList.add('hidden');
                submitButton.classList.remove('bg-gray-500');
                submitButton.classList.add('bg-cn-accent', 'hover:bg-emerald-600');
            }
        };

        // Helper function to display results
        const displayResponse = (data, isError = false) => {
            responsePanel.classList.remove('hidden');
            errorMessage.classList.add('hidden');
            responseDetails.innerHTML = ''; // Clear previous

            if (isError) {
                responsePanel.classList.remove('border-cn-accent');
                responsePanel.classList.add('border-red-500');
                errorMessage.classList.remove('hidden');
                errorMessage.textContent = data;
                document.querySelector('#response-panel h2').textContent = 'ERROR: Dispatch Failed';
                document.querySelector('#response-panel h2').classList.remove('text-cn-accent');
                document.querySelector('#response-panel h2').classList.add('text-red-400');
            } else {
                responsePanel.classList.add('border-cn-accent');
                responsePanel.classList.remove('border-red-500');
                document.querySelector('#response-panel h2').textContent = 'Job Dispatch Confirmed (HTTP 201)';
                document.querySelector('#response-panel h2').classList.add('text-cn-accent');
                document.querySelector('#response-panel h2').classList.remove('text-red-400');
                
                // Displaying key details nicely
                const detailsHtml = `
                    <p><span class="text-cn-secondary">Job Title:</span> <span class="font-bold">${data.title}</span></p>
                    <p><span class="text-cn-secondary">Status:</span> <span class="text-yellow-400 font-bold">${data.status}</span></p>
                    <p><span class="text-cn-secondary">Owner:</span> ${data.owner_email}</p>
                    <div class="pt-2">
                        <p class="text-cn-secondary text-sm">Job ID (UUID):</p>
                        <p class="font-mono text-sm break-all text-cn-accent">${data.id}</p>
                    </div>
                `;
                responseDetails.innerHTML = detailsHtml;
            }
        };

        // Main submission handler
        form.addEventListener('submit', async (e) => {
            e.preventDefault();

            const token = tokenInput.value.trim();
            const jobTitle = document.getElementById('job-title').value.trim();

            if (!token) {
                displayResponse("Authorization Token is required to submit a protected job.", true);
                return;
            }

            if (!jobTitle) {
                displayResponse("Job Title is required.", true);
                return;
            }

            setLoading(true);

            // Construct the JSON payload required by the current /api/v1/jobs route
            const jobPayload = {
                title: jobTitle,
                // The current schema requires a payload object for dynamic parameters
                payload: {
                    // This is where file artifact IDs or processing instructions would go post-MinIO integration
                    task_parameters: "default_execution_params"
                }
            };

            try {
                const response = await fetch(`${API_BASE_URL}/jobs`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(jobPayload),
                });

                const data = await response.json();

                if (response.ok && response.status === 201) {
                    displayResponse(data);
                } else {
                    // Handle API errors (e.g., 401 Unauthorized, 422 Validation Error)
                    const errorDetail = data.detail || (data.errors ? JSON.stringify(data.errors) : response.statusText);
                    displayResponse(`API Error ${response.status}: ${errorDetail}`, true);
                }

            } catch (error) {
                // Handle network errors
                console.error("Network Error:", error);
                displayResponse(`Network or Fetch Error: ${error.message}. Check your API URL and CORS settings.`, true);
            } finally {
                setLoading(false);
            }
        });

    </script>
</body>
</html>
