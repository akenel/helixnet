<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HelixNet Job Dashboard</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
        }
        .status-pill {
            padding: 4px 10px;
            border-radius: 9999px;
            font-weight: 600;
            font-size: 0.75rem;
            text-transform: uppercase;
            min-width: 90px;
            text-align: center;
        }
        /* Custom scrollbar for pre-formatted code block */
        pre::-webkit-scrollbar {
            height: 8px;
        }
        pre::-webkit-scrollbar-thumb {
            background-color: #cbd5e1;
            border-radius: 4px;
        }
        .job-id-link {
            cursor: pointer;
            color: #4f46e5;
            transition: color 150ms;
        }
        .job-id-link:hover {
            color: #6366f1;
            text-decoration: underline;
        }
    </style>
</head>
<body class="min-h-screen">

    <!-- Navigation Bar -->
    <nav class="bg-gray-800 shadow-lg sticky top-0 z-10">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <!-- Logo/Title -->
                <div class="flex items-center">
                    <span class="text-xl font-bold text-white tracking-wider">
                        üåå HelixNet <span class="text-indigo-400">Admin</span>
                    </span>
                </div>
                <!-- Navigation Links -->
                <div class="flex items-center space-x-4">
                    <a id="dashboardLink" href="#" class="text-white hover:bg-gray-700 px-3 py-2 rounded-md text-sm font-medium transition duration-150">Dashboard</a>
                    <!-- NEW LINK ADDED FOR NAVIGATION -->
                    <a href="/submit-form" class="text-gray-300 hover:bg-gray-700 hover:text-white px-3 py-2 rounded-md text-sm font-medium transition duration-150">Submit Job</a>
                    <a href="#" class="text-gray-300 hover:bg-gray-700 hover:text-white px-3 py-2 rounded-md text-sm font-medium transition duration-150">Users</a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Dashboard Content -->
    <main class="max-w-7xl mx-auto py-8 sm:px-6 lg:px-8">
        <div class="p-6 bg-white shadow-2xl rounded-xl">
            
            <!-- Job List View -->
            <div id="jobListView">
                <div class="flex justify-between items-center mb-6">
                    <h1 class="text-3xl font-extrabold text-gray-900 flex items-center">
                        <span class="mr-3 text-indigo-500">üìã</span>Chuck Norris Job Queue
                    </h1>
                    <button id="refreshButton" class="bg-indigo-600 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-indigo-700 transition duration-150 shadow-md flex items-center disabled:opacity-50">
                        <svg class="w-4 h-4 mr-2 animate-spin hidden" id="refreshSpinner" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2.1m15.356 2.1H15"></path></svg>
                        <span id="refreshText">Refresh Jobs</span>
                    </button>
                </div>

                <!-- Job List Table (Desktop View) -->
                <div class="hidden md:block overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider rounded-tl-lg">
                                    Job ID
                                </th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Title
                                </th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Owner
                                </th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider rounded-tr-lg">
                                    Status
                                </th>
                            </tr>
                        </thead>
                        <tbody id="jobTableBody" class="bg-white divide-y divide-gray-200">
                            <!-- Job rows will be injected here by JavaScript -->
                        </tbody>
                    </table>
                </div>

                <!-- Job List Cards (Mobile View) -->
                <div id="jobListMobile" class="md:hidden space-y-4">
                    <!-- Job cards will be injected here by JavaScript -->
                </div>
            </div>
            
            <!-- Job Detail View (Initially Hidden) -->
            <div id="jobDetailView" class="hidden">
                <button id="backButton" class="text-indigo-600 hover:text-indigo-800 text-sm font-medium mb-6 flex items-center transition duration-150">
                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                    Back to Job Queue
                </button>
                <h1 class="text-2xl font-bold text-gray-900 mb-4 flex items-center">
                    Job Details: 
                    <span id="detailJobId" class="text-indigo-600 font-mono text-xl ml-2 mr-4"></span>
                    <button id="copyJobIdButton" class="text-xs bg-gray-200 text-gray-700 px-3 py-1 rounded-md hover:bg-gray-300 transition duration-150 flex items-center">
                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2.217C17.925 5.074 18 5.174 18 5.374V17M13 10l-3 3 3 3"/></svg>
                        <span id="copyButtonText">Copy ID</span>
                    </button>
                </h1>
                
                <div id="detailContent">
                    <!-- Detail content will be injected here -->
                </div>
            </div>

            <p id="loadingIndicator" class="text-center py-8 text-gray-500 italic">Loading job data...</p>
            <p id="errorIndicator" class="text-center py-8 text-red-500 font-medium hidden">‚ùå Failed to load jobs. Check the API endpoint and authorization.</p>

        </div>
    </main>

    <script>
        // --- Configuration ---
        const API_URL = '/api/v1/jobs'; 
        // ‚ö†Ô∏è CHUCK NORRIS NOTE: This token is MOCKED. If you see auth errors, the issue is often here, 
        // or the backend isn't accepting it. This needs to be pulled from the real login flow.
        const MOCK_AUTH_TOKEN = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJkYTIzYTlkZC0wNzE5LTQ5NmYtODA0Zi01NDY1YzMxMjlmMDMiLCJzY29wZXMiOlsiYmFzaWMiXSwiaWF0IjoxNzYwNTMyMDkzLCJleHAiOjE3NjA1MzI5OTMsInR5cGUiOiJhY2Nlc3MiLCJqdGkiOiIwODI3NDkwZC1iY2E4LTQzNDktYjY5My0wODQyMjhjMzZlZWUifQ.Wt0ggSSFwZU39-VUCs_f97P_BTisBgAqENhTFxzuIMA";

        // --- DOM Elements ---
        const jobTableBody = document.getElementById('jobTableBody');
        const jobListMobile = document.getElementById('jobListMobile');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const errorIndicator = document.getElementById('errorIndicator');
        const refreshButton = document.getElementById('refreshButton');
        const refreshSpinner = document.getElementById('refreshSpinner');
        const refreshText = document.getElementById('refreshText');
        const backButton = document.getElementById('backButton');
        const jobListView = document.getElementById('jobListView');
        const jobDetailView = document.getElementById('jobDetailView');
        const detailJobId = document.getElementById('detailJobId');
        const detailContent = document.getElementById('detailContent');
        const copyJobIdButton = document.getElementById('copyJobIdButton');
        const copyButtonText = document.getElementById('copyButtonText');
        
        // --- State Management ---
        let allJobs = [];
        let currentView = 'list'; // 'list' or 'detail'

        // --- Utility Functions ---

        /**
         * Determines the Tailwind classes for the status pill based on the job status.
         */
        function getStatusClasses(status) {
            const normalizedStatus = status.toUpperCase();
            switch (normalizedStatus) {
                case 'COMPLETED':
                    return 'bg-green-100 text-green-800';
                case 'FAILED':
                case 'ERROR':
                    return 'bg-red-100 text-red-800';
                case 'IN_PROGRESS':
                case 'RUNNING':
                    return 'bg-blue-100 text-blue-800 animate-pulse';
                case 'PENDING (SHIM)': // Mock status, treat as Pending/Queued
                case 'PENDING':
                case 'QUEUED':
                default:
                    return 'bg-yellow-100 text-yellow-800';
            }
        }

        /**
         * Navigates the view between list and detail.
         */
        function setView(view, jobId = null) {
            currentView = view;
            if (view === 'list') {
                jobListView.classList.remove('hidden');
                jobDetailView.classList.add('hidden');
                fetchJobs(); // Refresh list when returning to list view
            } else if (view === 'detail' && jobId) {
                jobListView.classList.add('hidden');
                jobDetailView.classList.remove('hidden');
                renderJobDetail(jobId);
            }
        }

        /**
         * Renders a single job as a table row for desktop view.
         */
        function renderTableRow(job) {
            const statusClasses = getStatusClasses(job.status);
            const statusPill = `<span class="status-pill ${statusClasses}">${job.status}</span>`;
            
            return `
                <tr class="hover:bg-gray-50 transition duration-150">
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-mono">
                        <span class="job-id-link" data-job-id="${job.id}">${job.id.substring(0, 8)}...</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 truncate max-w-xs">
                        ${job.title}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        ${job.owner_email}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                        ${statusPill}
                    </td>
                </tr>
            `;
        }

        /**
         * Renders a single job as a mobile card for mobile view.
         */
        function renderMobileCard(job) {
            const statusClasses = getStatusClasses(job.status);
            const statusPill = `<span class="status-pill ${statusClasses}">${job.status}</span>`;

            return `
                <div class="bg-gray-50 p-4 rounded-lg shadow-sm border border-gray-200">
                    <div class="flex justify-between items-start mb-2">
                        <span class="text-xs font-mono text-indigo-600 job-id-link" data-job-id="${job.id}">${job.id.substring(0, 12)}...</span>
                        ${statusPill}
                    </div>
                    <p class="text-base font-semibold text-gray-900 mb-1">${job.title}</p>
                    <p class="text-sm text-gray-500">Owner: <span class="font-medium">${job.owner_email}</span></p>
                </div>
            `;
        }

        /**
         * Copies the full job ID to the clipboard and gives feedback.
         */
        function copyJobIdToClipboard(jobId) {
            document.execCommand('copy', false, jobId);
            copyButtonText.textContent = 'Copied! ‚úÖ';
            setTimeout(() => {
                copyButtonText.textContent = 'Copy ID';
            }, 2000);
        }

        /**
         * Renders the detailed view for a selected job.
         */
        function renderJobDetail(jobId) {
            const job = allJobs.find(j => j.id === jobId);
            
            if (!job) {
                detailJobId.textContent = 'Not Found';
                detailContent.innerHTML = `<p class="text-red-500 mt-4">Could not find job with ID: ${jobId}</p>`;
                return;
            }

            detailJobId.textContent = job.id;
            // Attach copy listener immediately
            copyJobIdButton.onclick = () => copyJobIdToClipboard(job.id);

            const statusClasses = getStatusClasses(job.status);
            const statusPill = `<span class="status-pill text-base ${statusClasses}">${job.status}</span>`;
            
            // Format JSON result content nicely
            let resultContentHtml;
            try {
                const result = job.result_content ? JSON.parse(job.result_content) : null;
                if (result) {
                    resultContentHtml = `
                        <pre class="bg-gray-100 p-4 rounded-lg text-sm overflow-x-auto border border-gray-300 shadow-inner max-h-96">${JSON.stringify(result, null, 2)}</pre>
                    `;
                } else {
                    resultContentHtml = '<p class="text-gray-500 italic">No structured result content available.</p>';
                }
            } catch (e) {
                resultContentHtml = `<p class="text-red-500 italic">Error parsing result content JSON: ${job.result_content}</p>`;
            }

            // Build the detail HTML
            detailContent.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                    <div class="bg-gray-50 p-4 rounded-lg border">
                        <h3 class="text-lg font-semibold text-gray-700 mb-2">Job Metadata</h3>
                        <p class="text-sm"><span class="font-medium">Title:</span> ${job.title}</p>
                        <p class="text-sm"><span class="font-medium">Owner:</span> ${job.owner_email}</p>
                        <p class="text-sm"><span class="font-medium">Status:</span> ${statusPill}</p>
                        <p class="text-sm"><span class="font-medium">Created At:</span> ${job.created_at ? new Date(job.created_at).toLocaleString() : 'N/A'}</p>
                    </div>
                    
                    <div class="bg-gray-50 p-4 rounded-lg border">
                        <h3 class="text-lg font-semibold text-gray-700 mb-2">Timing & Results</h3>
                        <p class="text-sm"><span class="font-medium">Started At:</span> ${job.started_at ? new Date(job.started_at).toLocaleString() : 'N/A'}</p>
                        <p class="text-sm"><span class="font-medium">Finished At:</span> ${job.finished_at ? new Date(job.finished_at).toLocaleString() : 'N/A'}</p>
                        <p class="text-sm break-words"><span class="font-medium">MinIO Result Key:</span> ${job.result_path || '<span class="italic text-gray-400">Not yet available</span>'}</p>
                        <p class="text-sm"><span class="font-medium">Input Key:</span> ${job.payload?.input_key || '<span class="italic text-gray-400">N/A</span>'}</p>
                    </div>
                </div>

                <h3 class="text-xl font-semibold text-gray-900 mb-3">Result Content Payload</h3>
                <div class="bg-white p-4 rounded-lg">
                    ${resultContentHtml}
                </div>
            `;
        }

        /**
         * Attaches click handlers to the newly rendered job ID links.
         */
        function attachJobLinkListeners() {
            document.querySelectorAll('.job-id-link').forEach(link => {
                link.addEventListener('click', (event) => {
                    const jobId = event.target.getAttribute('data-job-id');
                    if (jobId) {
                        setView('detail', jobId);
                    }
                });
            });
        }


        // --- Main Fetch and Render Logic ---

        /**
         * Fetches job data from the API and renders it to the dashboard.
         */
        async function fetchJobs() {
            jobTableBody.innerHTML = ''; 
            jobListMobile.innerHTML = '';
            loadingIndicator.classList.remove('hidden');
            errorIndicator.classList.add('hidden');
            refreshButton.disabled = true;
            refreshSpinner.classList.remove('hidden');
            refreshText.textContent = 'Loading...';
            
            try {
                const response = await fetch(API_URL, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'Authorization': `Bearer ${MOCK_AUTH_TOKEN}` 
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                allJobs = await response.json(); // Store all jobs in state
                
                if (allJobs.length === 0) {
                    jobTableBody.innerHTML = '<tr><td colspan="4" class="text-center py-6 text-gray-400">No active jobs found.</td></tr>';
                    jobListMobile.innerHTML = '<p class="text-center py-6 text-gray-400">No active jobs found.</p>';
                    return;
                }

                // Render for Desktop Table
                allJobs.forEach(job => {
                    jobTableBody.innerHTML += renderTableRow(job);
                });

                // Render for Mobile Cards
                allJobs.forEach(job => {
                    jobListMobile.innerHTML += renderMobileCard(job);
                });

                attachJobLinkListeners(); // Attach listeners after rendering
                
            } catch (error) {
                console.error("Error fetching jobs:", error);
                errorIndicator.classList.remove('hidden');
            } finally {
                loadingIndicator.classList.add('hidden');
                refreshButton.disabled = false;
                refreshSpinner.classList.add('hidden');
                refreshText.textContent = 'Refresh Jobs';
            }
        }

        // --- Event Listeners and Initialization ---

        // Attach event listener to the refresh button
        refreshButton.addEventListener('click', () => setView('list'));

        // Attach event listener to the back button in the detail view
        backButton.addEventListener('click', () => setView('list'));
        
        // Initial load of the jobs when the page loads
        window.onload = () => {
             // Start on the list view
             setView('list'); 
        };

    </script>
</body>
</html>
