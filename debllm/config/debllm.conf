#!/usr/bin/env bash
# ================================================================
# DebLLM Configuration
# ================================================================

# --- Paths ---
DEBLLM_ROOT="/home/angel/repos/helixnet/debllm"
DEBLLM_NOTES_DIR="${DEBLLM_ROOT}/notes"
DEBLLM_QUEUE_DIR="${DEBLLM_ROOT}/queue"
DEBLLM_ARCHIVE_DIR="${DEBLLM_ROOT}/archive"
DEBLLM_LOG_DIR="${DEBLLM_ROOT}/logs"

# --- Operating Mode ---
# Options: normal | hypercare | verbose | silent
DEBLLM_MODE="${DEBLLM_MODE:-normal}"

# --- Hyper-Care Mode Settings ---
# Duration in seconds (default: 4 hours = 14400 seconds)
HYPERCARE_DURATION=14400
# Start time (set this manually on deployment, or auto-detect)
HYPERCARE_START_TIME_FILE="${DEBLLM_ROOT}/config/hypercare_start_time"
if [[ -f "$HYPERCARE_START_TIME_FILE" ]]; then
    HYPERCARE_START_TIME=$(cat "$HYPERCARE_START_TIME_FILE")
else
    HYPERCARE_START_TIME=0  # Not in hyper-care mode
fi

# --- Alert Thresholds (by mode) ---
case "$DEBLLM_MODE" in
    hypercare)
        # Only new critical errors not in KB
        ALERT_SEVERITY="critical"
        ALERT_ONLY_NEW=true
        ALERT_ONLY_NOT_IN_KB=true
        CHECK_INTERVAL=300  # 5 minutes
        ;;
    normal)
        # All high/critical errors
        ALERT_SEVERITY="high"
        ALERT_ONLY_NEW=false
        ALERT_ONLY_NOT_IN_KB=false
        CHECK_INTERVAL=300  # 5 minutes
        ;;
    verbose)
        # Everything including warnings
        ALERT_SEVERITY="low"
        ALERT_ONLY_NEW=false
        ALERT_ONLY_NOT_IN_KB=false
        CHECK_INTERVAL=300  # 5 minutes
        ;;
    silent)
        # Monitoring only, no alerts
        ALERT_SEVERITY="none"
        CHECK_INTERVAL=600  # 10 minutes
        ;;
esac

# --- LLM Backend Configuration ---
# Options: local-only | claude-api | hybrid
DEBLLM_LLM_MODE="${DEBLLM_LLM_MODE:-local-only}"

# Local Ollama settings
OLLAMA_URL="http://localhost:11434"
OLLAMA_MODEL="llama3.2"

# Claude API settings (optional)
CLAUDE_API_KEY="${ANTHROPIC_API_KEY:-}"
CLAUDE_MODEL="claude-sonnet-4"
CLAUDE_MAX_TOKENS=4096

# Escalation threshold (if local LLM says ESCALATE or error count > threshold)
ESCALATE_ERROR_THRESHOLD=5

# --- Auto-Fix Settings ---
# Enable/disable auto-fix
AUTO_FIX_ENABLED=true

# What can be auto-fixed (comma-separated)
AUTO_FIX_ALLOWED="docker-restart,service-restart"

# Max auto-fix attempts before escalation
AUTO_FIX_MAX_ATTEMPTS=3

# --- Resolution Groups ---
declare -A RESOLUTION_GROUPS
RESOLUTION_GROUPS=(
    ["tech-devops"]="ralph@artemis.local"
    ["business-functional"]="sales-team@artemis.local"
    ["config-admin"]="devops@artemis.local"
    ["data-quality"]="support@artemis.local"
)

# --- Services to Monitor ---
MONITORED_SERVICES=(
    "helix-platform"
    "postgres"
    "redis"
    "keycloak"
    "worker"
    "beat"
    "traefik"
    "minio"
)

# --- Logging ---
DEBLLM_LOG_FILE="${DEBLLM_LOG_DIR}/debllm.log"
DEBLLM_STATUS_FILE="${DEBLLM_LOG_DIR}/debllm_status.json"

# --- Notification Settings ---
# Options: log-only | email | slack | webhook
NOTIFICATION_METHOD="log-only"

# Email settings (if NOTIFICATION_METHOD=email)
NOTIFICATION_EMAIL="admin@artemis.local"

# --- Maintenance Windows (errors expected, severity downgraded) ---
# Format: DAY:START_HOUR:END_HOUR (e.g., "SUN:03:04" = Sunday 3am-4am)
MAINTENANCE_WINDOWS=(
    "SUN:03:04"  # Sunday backup window
)

# ================================================================
# Helper Functions
# ================================================================

# Check if we're in hyper-care window
is_hypercare_active() {
    if [[ "$DEBLLM_MODE" != "hypercare" ]]; then
        return 1
    fi

    if [[ $HYPERCARE_START_TIME -eq 0 ]]; then
        return 1
    fi

    local now=$(date +%s)
    local elapsed=$((now - HYPERCARE_START_TIME))

    if [[ $elapsed -lt $HYPERCARE_DURATION ]]; then
        return 0
    else
        return 1
    fi
}

# Get remaining hyper-care time in minutes
get_hypercare_remaining() {
    if ! is_hypercare_active; then
        echo "0"
        return
    fi

    local now=$(date +%s)
    local elapsed=$((now - HYPERCARE_START_TIME))
    local remaining=$((HYPERCARE_DURATION - elapsed))
    echo "$((remaining / 60))"
}

# Check if we're in a maintenance window
is_maintenance_window() {
    local current_day=$(date +%a | tr '[:lower:]' '[:upper:]' | cut -c1-3)
    local current_hour=$(date +%H)

    for window in "${MAINTENANCE_WINDOWS[@]}"; do
        local day=$(echo "$window" | cut -d: -f1)
        local start_hour=$(echo "$window" | cut -d: -f2)
        local end_hour=$(echo "$window" | cut -d: -f3)

        if [[ "$current_day" == "$day" ]] && \
           [[ "$current_hour" -ge "$start_hour" ]] && \
           [[ "$current_hour" -lt "$end_hour" ]]; then
            return 0
        fi
    done

    return 1
}

# Log with timestamp
debllm_log() {
    local level="$1"
    shift
    local message="$*"
    echo "[$(date -Iseconds)] [$level] $message" >> "$DEBLLM_LOG_FILE"
}

# Export functions for use in other scripts
export -f is_hypercare_active
export -f get_hypercare_remaining
export -f is_maintenance_window
export -f debllm_log
