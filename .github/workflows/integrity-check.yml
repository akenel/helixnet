name: Check .gitignore Integrity

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  check_ignores:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check for Critical Ignores
        id: check_ignores
        run: |
          # Define the list of critical patterns that MUST be in .gitignore
          CRITICAL_PATTERNS=(
            ".env"
            "postgres-data"
            "models/"
            "*.pem"
            "*.key"
            "*.crt"
            "__pycache__"
          )

          # Initialize a list for missing patterns
          MISSING_PATTERNS=""

          # Check if each critical pattern is present in the .gitignore file (flexible matching)
          for pattern in "${CRITICAL_PATTERNS[@]}"; do
            if ! grep -q "$pattern" .gitignore; then
              MISSING_PATTERNS+="  - ${pattern}\n"
            fi
          done

          # Fail the job if any critical pattern is missing
          if [ -n "$MISSING_PATTERNS" ]; then
            echo "::error file=.gitignore::CRITICAL IGNORE PATTERNS MISSING"
            echo "The following critical patterns are MISSING from .gitignore:"
            echo -e "$MISSING_PATTERNS"
            exit 1
          else
            echo "âœ… .gitignore integrity check passed. All critical patterns are present."
          fi