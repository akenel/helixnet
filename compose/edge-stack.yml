# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ğŸ§± HELIX EDGE STACK (Core Infrastructure) - compose/edge-stack.yml
# Purpose: Public ingress, TLS termination, and core service routing gateway.
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
services:
  # ----------------------------------------------------
  # ğŸ˜ POSTGRES: Primary Application Database
  # ----------------------------------------------------
  postgres:
    image: postgres:17.6
    container_name: postgres
    restart: always
    env_file:
      - ../.env # Project root .env file
    environment:
      POSTGRES_USER: helix_user
      POSTGRES_PASSWORD: helix_pass
      POSTGRES_DB: helix_db
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - int_core
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $$POSTGRES_USER -d $$POSTGRES_DB"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  # ----------------------------------------------------
  # ğŸ›¡ TRAEFIK: Edge Router + TLS Gateway (MKCERT)
  # ----------------------------------------------------
  traefik:
    image: traefik:3.5.3
    container_name: traefik
    networks:
      - edge_public
      - int_core
    restart: always
    depends_on:
      postgres:
        condition: service_healthy 
    ports:
      - "80:80"       
      # Web (HTTP) - Redirect to HTTPS
      - "443:443"     
      # WebSecure (HTTPS) Helix Traefik Dashboard Unique special Port 8888 no conflicts
      - "8888:8080"   
      # Traefik Dashboard (External, Insecure API) 
    volumes:
      # static config file (must be a FILE on host)
      - ../compose/traefik/traefik.yml:/etc/traefik/traefik.yml:ro
      # dynamic directory (must be a directory on host)
      - ../compose/traefik/dynamic:/etc/traefik/dynamic:ro
      # certificates (dir)
      - ../compose/traefik/certs:/etc/traefik/certs:ro
      # mkcert root CA (if you need it inside containers)
      - ../compose/traefik/ca/rootCA.pem:/usr/local/share/ca-certificates/mkcert-rootCA.pem:ro
      # docker socket (only if you want Docker provider)
      - /var/run/docker.sock:/var/run/docker.sock:ro
    command:
      - "--ping=true"
      - "--ping.entrypoint=traefik"
      - --serversTransport.insecureSkipVerify=true
      # Static Configuration File (only set once)
      - --configFile=/etc/traefik/traefik.yml
      # API/Dashboard Configuration
      - --api.insecure=false
      # Keep this FALSE in production!
      - --api.dashboard=true
      # Providers
      - --providers.docker=true
      # Correct: Relying on file providers
      - --providers.file.directory=/etc/traefik/dynamic
      # Dynamic files are here
      - --providers.file.watch=true
      # Ensure it picks up changes
      # Entrypoints (Often better defined in traefik.yml, but safe here)
      - --entrypoints.web.address=:80
      - --entrypoints.websecure.address=:443
      # Health Check / Logging
      - --log.level=INFO
    healthcheck:
      # Check if the internal Traefik API/Management port (often 8080 or 8081) is listening.
      # You may need to check your Traefik config for the exact internal port (usually 8080/8081).
      test: ["CMD-SHELL", "nc -z 127.0.0.1 8080"] 
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # ğŸ“§ MailHog - Email Testing
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  mailhog:
    image: mailhog/mailhog:v1.0.1
    container_name: mailhog
    expose:
      - "1025"       
      # SMTP
      - "8025"       
      # Web UI
    ports:
      - "8025:8025"  
      # Optional if you want to access outside Docker
      - "1025:1025"  
      # for keycloak SMTP Host: mailhog SMTP Port: 1025
    networks:
      - int_core
      - edge_public
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://127.0.0.1:8025"]
      interval: 30s
      timeout: 10s
      retries: 10
      start_period: 10s
  
  # ----------------------------------------------------
  # ğŸ§­ PORTAINER: Docker Management UI
  # ----------------------------------------------------
  portainer:
    image: portainer/portainer-ce:alpine
    container_name: portainer
    command: -H unix:///var/run/docker.sock
    ports: 
      # HTTPS API/UI
      - "9443:9443"
    networks:
      - int_core
      - edge_public
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - portainer_data:/data
    # Use a solid restart policy to ensure it comes back up
    restart: unless-stopped
    depends_on:
      # Depend on postgres *and* keycloak to be healthy for a full startup
      # keycloak:
      #   condition: service_healthy
      postgres:
        condition: service_healthy
    healthcheck:
      # Check for the main Portainer data folder that is created on startup
      test: ["CMD", "test", "-d", "/data"] 
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
  # ----------------------------------------------------
  # ğŸ¥ ADMINER: Lightweight PostgreSQL Web UI
  # ----------------------------------------------------
  adminer:
    image: adminer:5.4.1-standalone
    container_name: adminer
    expose:
      - "8080"
    ports:
      - "8083:8080"
    networks:
      - int_core
      - edge_public
    depends_on:
      postgres:
        condition: service_healthy 
        # Wait for DB
    # Adminer is stateless, so we remove the unnecessary volume
    healthcheck:
      # Check for the main index file that is served
      test: ["CMD", "test", "-f", "/var/www/html/index.php"] 
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  # ----------------------------------------------------
  # ğŸ§¾ PROMETHEUS: Metrics Collector
  # ----------------------------------------------------
  prometheus:
    image: prom/prometheus:v3.7.3
    container_name: prometheus
    user: "0:0"
    ports:
      - "9090:9090"
    volumes:
      # - ./prometheus/config:/etc/prometheus
      - prometheus_data:/prometheus
    command:
      - "--config.file=/etc/prometheus/prometheus.yml"
      - "--storage.tsdb.path=/prometheus"
    networks:
      - int_core
      - edge_public
    healthcheck:
      # Check for the mounted Prometheus config file
      test: ["CMD", "test", "-f", "/etc/prometheus/prometheus.yml"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
  # ----------------------------------------------------
  # ğŸ’¹ GRAFANA: Dashboards and Visualizations
  # ----------------------------------------------------
  grafana:
    image: grafana/grafana:12.3.0-18733571275
    container_name: grafana
    user: "0:0"
    expose:
      - "3000"
    volumes:
      # Use only the named volume for persistence, using the default path
      - grafana_data:/var/lib/grafana
    networks:
      - int_core
      - edge_public
    depends_on:
      postgres:
        condition: service_healthy 
        # Assuming Grafana connects to Postgres as a datasource
    healthcheck:
      # Check for Grafana's core configuration file
      test: ["CMD", "test", "-f", "/etc/grafana/grafana.ini"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
  # ----------------------------------------------------
  # ğŸ—„ FILEBROWSER: Lightweight File Manager
  # ----------------------------------------------------
  filebrowser:
    image: filebrowser/filebrowser:v2-s6
    container_name: filebrowser
    expose:
      - "80"
    ports:
      - "8082:80"
    volumes:
      - ./data/files:/srv 
      # Maps local files to the container's serve directory
    networks:
      - int_core
      - edge_public
    depends_on:
      postgres:
        condition: service_healthy
        
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ğŸ—‚ï¸ VOLUMES
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
volumes:
  postgres_data: 
    name: helix_postgres_data
  portainer_data:
    name: helix_portainer_data
  prometheus_data:
    name: helix_prometheus_data
  grafana_data: 
    name: helix_grafana_data
    
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ğŸŒ NETWORKS
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
networks:
  edge_public:
    name: edge_public
    external: true
  int_core:
    name: int_core
    external: true
