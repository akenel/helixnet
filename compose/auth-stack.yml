# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ğŸ›¡ï¸ AUTH STACK | auth-stack.yml
# Purpose: Isolated, stable auth stack for HelixNet
# Changes:
# 1. Keycloak environment variables now use the cleaner YAML Map format (KEY: VALUE).
# 2. Mailhog now includes the suggested healthcheck.
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
services:
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ğŸ” Keycloak (24.x) - Enterprise-Ready HTTPS Setup
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  keycloak:
    build:
      context: .
      dockerfile: keycloak/Dockerfile.keycloak
    image: helix-keycloak:24.0.4-stable
    container_name: keycloak
    restart: always
    env_file:
      - ../.env
    command: 
          - start
          - --import-realm
    networks:
      - int_core
      - edge_public
    ports:
      - "8080:8080"
      - "8443:8443"
# Keycloak health/metrics generally run on the Management Port (9000) by default
      - "9999:9000"
    depends_on:
      postgres:
        condition: service_healthy 
      mailhog:
        condition: service_healthy
    volumes:
        # Note: Add the start-dev command and the --import-realm flag
          - ./keycloak/config:/opt/keycloak/data/import:ro
          # â”€â”€â”€â”€â”€ Persistent Data Fix â”€â”€â”€â”€â”€
          - ./compose/traefik/ca/rootCA.pem:/usr/local/share/ca-certificates/mkcert.crt:ro
          # mount host files to container internal paths.
          - ./traefik/certs/cert.pem:/etc/x509/https/tls.crt:ro
          - ./traefik/certs/key.pem:/etc/x509/https/tls.key:ro
          # The presence of this volume is what causes the configuration to persist 
          # and the optimization step to run repeatedly if files are changed.
          # make import file visible to the running container (always)
          - ./keycloak/config/kc-realm-dev.json:/opt/keycloak/data/import/kc-realm-dev.json:ro
          # persistent data (optional). If you leave this, it will hide image-copied files â€”
          # but the explicit bind mount above wins for import file.
          - keycloak_data:/opt/keycloak/data
    environment:
      # â”€â”€â”€â”€â”€ Hostname + Proxy â”€â”€â”€â”€â”€
      KC_HTTP_ENABLED: true
      KC_HTTPS_ENABLED: false
      KC_PROXY_HEADERS: xforwarded
      KC_HOSTNAME: keycloak.helix.local
      KC_HOSTNAME_STRICT: "false"
      KC_HOSTNAME_STRICT_HTTPS: "false"
    
      KC_DB_URL_HOST: postgres # Redundant, but safe
      KC_HTTP_PORT: 8080                 
      KC_DB_URL_PORT: 5432
      KC_DB_URL_DATABASE: helix_db
      KC_HTTPS_PORT: 8443
      KC_DB: postgres
      KC_DB_URL: jdbc:postgresql://postgres:5432/helix_db
      KC_DB_USERNAME: helix_user
      KC_DB_PASSWORD: helix_pass
      KC_DB_SCHEMA: public

      KC_LOG_LEVEL: INFO
      KEYCLOAK_ADMIN: helix_user
      KEYCLOAK_ADMIN_PASSWORD: helix_pass  
      # Enable transaction recovery for production stability
      QUARKUS_TRANSACTION_MANAGER_ENABLE_RECOVERY: "true"
      # â”€â”€â”€â”€â”€ HTTPS Certificate â”€â”€â”€â”€â”€
      # mkcert generates local certs; mounted below
      KC_HTTPS_CERTIFICATE_FILE: /etc/x509/https/tls.crt
      KC_HTTPS_CERTIFICATE_KEY_FILE: /etc/x509/https/tls.key
      # â”€â”€â”€â”€â”€ Admin + Realm Import â”€â”€â”€â”€â”€
      KC_IMPORT_FILE: kc-realm-dev.json
      KC_IMPORT: /opt/keycloak/import/kc-realm-dev.json
      KC_IMPORT_STRATEGY: IGNORE_EXISTING
      # JAVA_OPTS_APPEND: -Dkeycloak.profile=preview 
      # â”€â”€â”€â”€â”€ Mail Settings â”€â”€â”€â”€â”€
      KC_MAIL_FROM: noreply@helix.local
      KC_MAIL_SMTP_HOST: mailhog
      KC_MAIL_SMTP_PORT: 1025
      KC_MAIL_SMTP_AUTH: "false"
      KC_MAIL_SMTP_SSL: "false"
      KC_MAIL_SMTP_STARTTLS: "false"
      KC_SPI_EMAIL_FROM_DISPLAY_NAME: "HelixNet Keycloak Authority"
      KC_SPI_EMAIL_TEMPLATE_PROVIDER: freemarker
      KC_HEALTH_ENABLED: true
      KC_METRICS_ENABLED: true
      KC_HTTP_MANAGEMENT_ENABLED: true # Optional but good practice to isolate health on management port
      KC_HTTP_MANAGEMENT_PORT: 9999   # Default, but explicit is better
    healthcheck:
            test: ["CMD", "test", "-f", "/opt/keycloak/conf/keycloak.conf"]
            interval: 10s
            timeout: 5s
            retries: 5
            start_period: 30s

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # ğŸ” Vault (supports dev-mode via env OR config.hcl)
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  vault:
    image: hashicorp/vault:1.21
    container_name: vault
    cap_add:
      - IPC_LOCK
    ports:
      - "8200:8200"
    volumes:
      - ./vault/config:/vault/config:ro
      - vault_data:/vault/data
    command: >
      sh -c '
      if [ -n "${VAULT_DEV_ROOT_TOKEN_ID:-}" ]; then
        echo "Starting Vault in dev mode with root token root-token";
        vault server -dev \
          -dev-root-token-id=root-token \
          -dev-listen-address="0.0.0.0:8200" \
          -dev-ha \
          -log-level=info;
      else
        echo "Starting Vault server with config file";
        vault server -config=/vault/config/config.hcl;
      fi
      '
    environment:
      # --- Dev mode & API addresses ---
      VAULT_DEV_ROOT_TOKEN_ID: root-token:-root-token}
      VAULT_DEV_LISTEN_ADDRESS: "0.0.0.0:8200"
      VAULT_ADDR: "http://vault:8200"
      VAULT_API_ADDR: "http://vault:8200"
      VAULT_CLUSTER_ADDR: "https://vault:8201"
      VAULT_LOG_LEVEL: info
      VAULT_SKIP_VERIFY: "true" 
      # allows mkcert TLS without validation errors

    # *** THESE KEYS WERE INDENTED UNDER 'environment' AND HAVE BEEN MOVED HERE ***
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - int_core
      - edge_public
    healthcheck:
      # KICK: Keep it clean and simple! Use wget and the service name (vault)
      # to check the internal health endpoint. Vault in dev mode should return 200.
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://127.0.0.1:8200/v1/sys/health || exit 1"]
      interval: 15s
      timeout: 10s
      retries: 10
      start_period: 40s 
      # Vault needs extra time to initialize and unseal.
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ğŸŒ Networks
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
networks:
  edge_public:
    external: true
  int_core:
    external: true

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ğŸ—‚ï¸ Volumes
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
volumes:
  keycloak_data:
  vault_data: