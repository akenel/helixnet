# -------------------------------------------------------------
# Stage 2. Main / Helix Stack	App layer	
# Helix Platform + Keycloak + Worker + Beat + Flower + MailHog
# ğŸ›¡ï¸ Main HELIX API STACK compose/helix-main/main-stack.yml
# ğŸ”ï¸ Helix Platform Base Images 
# -------------------------------------------------------------
# ğŸ¿ï¸ Reusable base service config  
# -------------------------------------------------------------
x-base: &base
  image: helix-platform:latest
  env_file: ../../env/helix.env
  restart: unless-stopped
  networks:
    - helixnet_core
  # healthcheck:
  #   # ğŸš¨ FIX: Use a simple port/root path check.
  #   test: ["CMD-SHELL", "wget -q -O /dev/null http://localhost:8000/ || exit 1"]
  #   interval: 10s
  #   timeout: 5s
  #   retries: 5
  #   # ğŸš¨ CRITICAL: Give the platform 2.5 minutes to fully boot and connect to Postgres.
  #   start_period: 60s
# -------------------------------------------------------------
# ğŸ’¦ï¸ Services Helix main API ğŸ›¡ï¸
# -------------------------------------------------------------
services:
# -------------------------------------------------------------
# ğŸ§°ï¸ Helix main API 
# -------------------------------------------------------------
  helix-platform:
    <<: *base
    container_name: helix-platform
    build:
      context: ../../
      dockerfile: compose/helix-main/Dockerfile.helix-platform
    ports:
      - "9003:8000"
    environment: # Optional for custom build configurations
      PLATFORM_CONFIG: /app/config/platform-settings.yaml
    volumes:
      - ./compose/config:/app/config
      - ../../src:/app/src
    networks:
      - helixnet_core
      - helixnet_edge
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health/healthz"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
# -------------------------------------------------------------
# â›‘ï¸ Worker ğŸ¥¬ï¸ Celery 
# -------------------------------------------------------------
  worker:
    <<: *base
    container_name: worker
    build:
      context: ../../
      dockerfile: compose/helix-main/Dockerfile.worker
      # deploy:
      #   replicas: 3
      #   resources:
      #     reservations:
      #       cpus: '0.5'
      #       memory: 1G
      #     limits:
      #       cpus: '2'
      #       memory: 4G
    environment:
      SERVICE_TYPE: worker
    volumes:
      - ../../src:/app/src
    depends_on:
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "celery", "-A", "src.tasks.celery_app:app", "inspect", "ping", "-t", "3"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 40s
# -------------------------------------------------------------
# ğŸ¥ï¸ Beat ğŸ¥¬ï¸ Celery 
# -------------------------------------------------------------
  beat:
    <<: *base
    container_name: beat
    build:
      context: ../../
      dockerfile: compose/helix-main/Dockerfile.beat
    environment:
      SERVICE_TYPE: beat
    volumes:
      - ../../src:/app/src
      - beat_data:/app/beat-data
    depends_on:
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "celery", "-A", "src.tasks.celery_app:app", "inspect", "scheduled", "-t", "3"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 40s
# -------------------------------------------------------------
#  ğŸŒï¸ Flower ğŸ¥¬ï¸ Monitoring 
# -------------------------------------------------------------
  flower:
    <<: *base
    container_name: flower
    build:
      context: ../../
      dockerfile: compose/helix-main/Dockerfile.flower
    environment:
      SERVICE_TYPE: flower
    ports:
      - "5555:5555"
    volumes:
      - ../../src:/app/src
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5555/healthcheck"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 40s
# -------------------------------------------------------------
# ğŸ—‚ï¸ NAMED VOLUMES
# -------------------------------------------------------------
volumes:
  beat_data:
# -------------------------------------------------------------
# ğŸªï¸ Networks
# -------------------------------------------------------------
networks:
  helixnet_core:
    external: true
  helixnet_edge:
    external: true
