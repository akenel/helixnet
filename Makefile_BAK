# =======================================================
# ğŸ§  HelixNet Makefile â€“ The Professional Standard ğŸ§ 
# =======================================================
# Purpose : Simplified, descriptive orchestration for Docker Compose
# Author  : Gemini, your development partner and Angel the fixer
# Updated : 2025-10-20 v1.0.0 (The Bruce Lee Chop)
# =======================================================
.ONESHELL:
SHELL := /bin/bash
include .env
COMPOSE_FILE := docker-compose.yml
PROJECT_NAME := helixnet
DB_NAME := postgres
DB_USER := postgres

# --- Profiles & Variables (KIC KIS) ---
CORE_PROFILES := --profile core
APP_PROFILES  := --profile app
WEB_SERVICE   := helix-web-app
# --- Emoji Helpers (The Chuck Standard) ---
# Main States
START = @echo "ğŸŸ¢ [INIT] Starting up the engines..."
STOP  = @echo "ğŸ”´ [SHUTDOWN] Ceasing operations..."
DONE  = @echo "âœ¨ [COMPLETE] Task finished successfully."
WARN  = @echo "âš ï¸  [ATTENTION] Proceed with caution."
FAIL  = @echo "âŒ [FAILURE] Something went wrong."
# Actions
DB    = @echo "ğŸ’¾ [DATABASE] "
CODE  = @echo "ğŸ’» [CODEBASE] "
TEST  = @echo "ğŸ§ª [TESTING] "
BUILD = @echo "ğŸ—ï¸  [BUILDING] "
CLEAN = @echo "ğŸ§¹ [CLEANUP] "
# =======================================================
# ğŸš€ 1. LIFECYCLE MANAGEMENT (Full Stack)
# =======================================================
.PHONY: up
up: ## â¬†ï¸  Bring the entire stack up (Use 'make rebuild' for code updates)
	$(START) "Starting ALL containers in detached mode..."
	# ğŸš¨ FIX: Explicitly include both CORE and APP profiles to ensure all services start
	set -a; . ./.env; set +a; docker compose -f $(COMPOSE_FILE) $(CORE_PROFILES) $(APP_PROFILES) up -d --remove-orphans
	$(DONE) "HelixNet is LIVE! Access links via 'make links'. ğŸŒ"

.PHONY: down
down: ## â¬‡ï¸  Stop and remove all containers gracefully
	$(STOP) "Stopping HelixNet stack..."
	docker compose -f $(COMPOSE_FILE) down --remove-orphans

.PHONY: build
build: ## ğŸ—ï¸  Build all Docker images from their latest source
	$(BUILD) "Re-compiling Docker images for Core and App services..."
	docker compose -f $(COMPOSE_FILE) build
	$(DONE) "All images built successfully! âœ…"

.PHONY: rebuild
rebuild: down build up ## ğŸ”¨ Full clean reset: stop, rebuild images, restart containers
	$(CODE) "Executing full environment reset and rebuild (down -> build -> up)..."
	$(DONE) "Full rebuild completed! We are running on fresh code and containers. ğŸ§©"

.PHONY: core-up
core-up: ## ğŸ§± Start only core infra (DB, Redis, Keycloak)
	$(DB) "Starting essential core infrastructure services..."
	set -a; . ./.env; set +a; \
	docker compose -f $(COMPOSE_FILE) $(CORE_PROFILES) up -d --remove-orphans
	@echo "ğŸ§± [CORE UP] Core services started (check health with 'make wait-for-health')."
# =======================================================
.PHONY: deploy-code
deploy-code: build ## ğŸ“¦ Build new code images and restart web/workers (Fast code update)
	$(CODE) "Building new application images (Web, Worker, Beat) to grab latest code..."
	docker compose -f $(COMPOSE_FILE) $(APP_PROFILES) build
	$(CODE) "Restarting application services using the newly built images..."
	# Restart using --no-deps to only touch the application containers
	docker compose -f $(COMPOSE_FILE) $(APP_PROFILES) up -d --no-deps --remove-orphans
	$(DONE) "New code is deployed and application services are running. ğŸ¥³"
# =======================================================
# ğŸ—„ï¸ 3. DATABASE MANAGEMENT
# =======================================================
.PHONY: setup
setup: core-up wait-for-health migrate seed ## ğŸ’¾ Complete initial setup (migrate, then seed)
	$(DB) "Initial application setup complete! Ready to accept requests. ğŸš€"

.PHONY: migrate
migrate: core-up wait-for-health ## ğŸ§¬ Apply Alembic migrations to the database head
	$(DB) "Applying new database migrations to the latest head..."
	docker compose run --rm $(WEB_SERVICE) alembic upgrade head
	$(DONE) "Migrations applied successfully! Database schema is up-to-date. ğŸ‰"

.PHONY: rev
rev: core-up wait-for-health ## âœï¸ Create a new Alembic migration (usage: make rev msg="Your description")
	$(DB) "Generating new Alembic revision: $(msg)..."
	docker compose run --rm $(WEB_SERVICE) alembic revision --autogenerate -m "$(msg)"
	$(DONE) "New revision created. Check 'migrations/versions/' folder. ğŸª¶"

.PHONY: seed
seed: core-up wait-for-health ## ğŸ¥• Run the initial data seeding script (admin user creation, etc.)
	$(DB) "Executing initial data seeding script..."
	# ğŸŒ KEYCLOAK REALM IMPORT: THE BRUCE LEE PRECISION STRIKE ğŸ‰
	@echo "ğŸŒ [KEYCLOAK] Attempting realm 'helixnet' import..."
	docker exec keycloak /opt/keycloak/bin/kc.sh import \
		--file /opt/keycloak/data/import/helix-realm.json \
		--realm helixnet
	@echo "âœ… Realm import attempt finished."
	# ğŸ”‘ Next, run the user seeding script
	docker compose run --rm $(WEB_SERVICE) python app/scripts/seed_users.py
	$(DONE) "Data seeding complete! Users and base data are ready. ğŸ‘¤"

.PHONY: db-nuke
db-nuke: down ## ğŸ’¥ Nuke DB (Stop, remove volumes, restart core, migrate, seed)
	$(WARN) "ğŸš¨ DANGER ZONE: This will wipe ALL database volumes and data!"
	$(CLEAN) "Removing all volumes associated with the stack..."
	# 1. ğŸ§¹ CLEAN UP: Remove containers/volumes
	docker compose -f $(COMPOSE_FILE) down -v --remove-orphans
	# 2. ğŸ’¾ START & SETUP
	$(MAKE) setup
	$(DONE) "Full db-nuke and setup completed. Ready for development. ğŸ‰"
# =======================================================
# ğŸ§° 4. UTILITIES & ACCESS
# =======================================================
.PHONY: logs
logs: ## ğŸ“œ Tail logs from all running containers
	@echo "ğŸ‘ï¸  [LOGS] Tailing logs... (Ctrl+C to stop)"
	docker compose -f $(COMPOSE_FILE) logs -f

.PHONY: shell
shell: ## ğŸ§‘â€ğŸ’» Open an interactive BASH shell inside the main web container
	@echo "ğŸ¦ª [SHELL] Opening BASH inside the $(WEB_SERVICE) container..."
	docker compose exec $(WEB_SERVICE) bash

.PHONY: python
python: ## ğŸ Open an interactive PYTHON shell inside the main web container
	@echo "ğŸ [PYTHON] Opening interactive Python environment..."
	docker compose exec $(WEB_SERVICE) python

.PHONY: users
users: core-up wait-for-health ## ğŸ‘¤ Query and display all existing user emails
	$(DB) "Fetching all user emails from the database..."
	docker compose run --rm $(WEB_SERVICE) python app/scripts/show_users.py
	$(DONE) "User list retrieved. ğŸ‘¥"

.PHONY: links
links: ## ğŸ”— Show quick access links for local services
	@echo "\nğŸŒ --- HelixNet Access Links ---"
	@echo "ğŸ GitHub Repo:              https://github.com/akenel/helixnet/tree/main"
	@echo "ğŸ’» WebApp Backend OpenAPI:   http://helix.local/docs"
	@echo "ğŸ‡ Flower UI (Celery):       http://0.0.0.0:5555/"
	@echo "ğŸ“¨ RabbitMQ Mgmt:            http://localhost:15672/"
	@echo "ğŸ—„ï¸ MinIO Console:            http://0.0.0.0:9091/"
	@echo "ğŸ§  PgAdmin UI:               http://0.0.0.0:5050/browser/"
	@echo "-----------------------------------\n"

.PHONY: wait-for-health
wait-for-health: ## â³ Wait for critical services (postgres, keycloak) to become healthy
	@echo "â³ [WAITING] Waiting for Postgres and Keycloak to reach 'healthy' state..."
	# Use 'wait' command for the services tagged as healthy
	docker compose wait postgres keycloak
	$(DONE) "Critical services are Healthy."

.PHONY: kc-token
kc-token: ## ğŸ”‘ Retrieve and test the Keycloak Admin Access Token (for verification)
	@echo "ğŸ”‘ [KEYCLOAK] Requesting Admin Token from Keycloak using service script..."
	@docker compose run --rm $(WEB_SERVICE) python app/scripts/get_admin_token.py
	$(DONE) "Admin Token script executed."

# =======================================================
# ğŸ§ª 5. TESTING SUITE
# =======================================================
.PHONY: test-unit
test-unit: ## ğŸ§ª Run Python unit/integration tests (isolated DB)
	$(TEST) "Running Python unit tests with isolated test DB (ENV=testing)..."
	docker compose exec -e ENV=testing $(WEB_SERVICE) bash -c "
	echo 'ğŸ¥‹ Chuck Norris enters the test dojo...' && 
	cd /code/app/tests && 
	pytest -vv --color=yes --maxfail=1 --disable-warnings --tb=short && 
	echo 'âœ… All tests passed! Chuck Norris approves. ğŸ‘Š' || 
	( echo 'ğŸ’€ Tests failed. Chuck Norris is displeased. âš¡' && exit 1 )"
	$(DONE) "Unit test suite completed. ğŸ§ "

.PHONY: test-e2e
test-e2e: ## ğŸ”‘ Run authenticated E2E API tests (login + token validation)
	$(TEST) "Running authenticated End-to-End API tests (E2E)..."
	docker compose exec $(WEB_SERVICE) bash /code/app/tests/test_api.sh
	$(DONE) "E2E API tests completed successfully. ğŸ”"

.PHONY: test
test: setup test-unit test-e2e ## ğŸ¯ Full test suite: start, setup, run unit + E2E
	$(DONE) "The full HelixNet test suite has executed successfully! Everything is green. ğŸ¥‡"

.PHONY: smoke
smoke: ## ğŸ’¨ Run the helix-super-smoke quick health check
	$(TEST) "Running quick smoke test script..."
	docker compose exec $(WEB_SERVICE) bash app/scripts/helix-super-smoke.sh
	$(DONE) "Smoke test successful. Health check passed. ğŸ’¨"

# =======================================================
# ğŸ•µï¸ 6. HELP MENU & INSPECTION
# =======================================================
.PHONY: help
help: ## â“ Show this descriptive help menu
	@clear
	@echo "ğŸ” \033[1mAvailable Commands for HelixNet:\033[0m\n"
	@grep -E '^[a-zA-Z_-]+:.*##' $(MAKEFILE_LIST) | \
	awk 'BEGIN {FS = "##"}; \
	{ \
	cmd=$$1; \
	sub(/^.*Makefile:/, "", cmd); \
	gsub(/:.*/, "", cmd); \
	printf "%s\t\033[36m make %-20s\033[0m\n", $$2, cmd \
	}'
	@echo "  ğŸ’¡ Example: make rebuild && make setup   ğŸš€"    

.PHONY: show-tables
show-tables: core-up wait-for-health ## ğŸ“Š List all tables in the public schema and their owners
	@echo "========================================"
	@echo "ğŸ“‚ DATABASE TABLES (DB: $(DB_NAME))"
	@echo "========================================"
	docker compose exec db psql -d $(DB_NAME) -U $(DB_USER) -c '\dt'

.PHONY: show
show: show-tables users ## ğŸ¯ Consolidated command: Show all DB inspection data (tables + users)
	@echo "\n========================================"
	@echo "âœ… DB inspection complete."
	@echo "========================================\n"
